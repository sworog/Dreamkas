/**
 * Adapted from the official plugin text.js
 *
 * Uses UnderscoreJS micro-templates : http://documentcloud.github.com/underscore/#template
 * @author Julien Cabanès <julien@zeeagency.com>
 * @version 0.2
 * 
 * @license RequireJS text 0.24.0 Copyright (c) 2010-2011, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/requirejs for details
 */

// moment.js
// version : 2.0.0
// author : Tim Wood
// license : MIT
// momentjs.com

define("kit/_utils/deepExtend",[],function(){return function e(t){var n=Array.prototype.slice,r=Object.prototype.hasOwnProperty;return _.each(n.call(arguments,1),function(n){for(var i in n)if(r.call(n,i))if($.isPlainObject(t[i])&&$.isPlainObject(n[i]))t[i]=e({},t[i],n[i]);else{switch(n[i]){case"false":n[i]=!1;break;case"true":n[i]=!0}t[i]=n[i]}}),t}}),define("kit/_utils/inherit",["require","kit/_utils/deepExtend"],function(e){var t=e("kit/_utils/deepExtend");return function(e,n){var r=this,i;e&&_.has(e,"constructor")?i=e.constructor:i=function(){return r.apply(this,arguments)},t(i,r,n);var s=function(){this.constructor=i};return s.prototype=r.prototype,i.prototype=new s,e&&t(i.prototype,e),i.__super__=r.prototype,i}}),define("kit/block",["require","kit/_utils/deepExtend","kit/_utils/inherit"],function(e){var t=e("kit/_utils/deepExtend"),n=e("kit/_utils/inherit"),r=Backbone.View.extend({templates:{},className:null,blockName:null,addClass:null,tagName:"div",constructor:function(e){var n=this;t(n,e),n.cid=_.uniqueId("block"),n._ensureElement(),n.findElements(),n.delegateEvents(),n.initialize.apply(n,arguments),n.$el.addClass(n.className).addClass(n.addClass).attr("block",n.blockName||n.className).data("block",n)},initialize:function(){var e=this;e.templates.index&&e.render()},render:function(){var e=this,t=$(e.templates.index({block:e}));e.$el.children("[block]").each(function(){$(this).data("block").remove()}),e.$el.html(t).require(),e.findElements(),e._afterRender()},findElements:function(){var e=this,t=arguments[0]||e.$el,n=[];e.className&&(t.find('[class*="'+e.className+'__"]').each(function(){var t=_.filter($(this).attr("class").split(" "),function(t){return t.indexOf(e.className+"__")===0});n=_.union(n,t)}),_.each(n,function(t){var n=t.split("__")[1];e["$"+n]=e.$el.find("."+t)}))},_afterRender:function(){},remove:function(){var e=this;e.$el.find(["block"]).each(function(){$(this).data("block").remove()}),Backbone.View.prototype.remove.call(this)},set:function(e,n,r){var i=this,s=this,o;r=t({canceled:!1,cancel:function(){this.canceled=!0}},r);if(_.isObject(e)){_.each(e,function(e,t){i.set(t,e,r)});return}_.isFunction(i["set:"+e])&&(o=i["set:"+e](n,r));if(r.canceled){r.canceled=!1;return}o!==undefined&&(n=o),_.isObject(n)&&!_.isElement(n)&&!_.isArray(n)?_.each(n,function(t,n){i.set(e+"."+n,t,r)}):_.each(e.split("."),function(e,t,r){typeof s[e]=="undefined"&&(s[e]={}),t==r.length-1?s[e]=n:s=s[e]}),i.trigger("set:"+e,n)}});return r.extend=n,r}),define("collections/baseCollection",["require"],function(e){return Backbone.Collection.extend({fetch:function(e){return Backbone.Collection.prototype.fetch.call(this,_.extend({reset:!0},e))}})}),define("models/baseModel",["require"],function(e){return Backbone.Model.extend({save:function(e,t){return Backbone.Model.prototype.save.call(this,e,_.extend({wait:!0,isSave:!0},t))},destroy:function(e){Backbone.Model.prototype.destroy.call(this,_.extend({wait:!0},e))},toJSON:function(e){e=e||{};var t=Backbone.Model.prototype.toJSON;return e.isSave?_.pick(t.apply(this,arguments),this.saveFields):t.apply(this,arguments)}})}),define("models/product",["require","models/baseModel"],function(e){var t=e("models/baseModel");return t.extend({modelName:"product",urlRoot:baseApiUrl+"/products",defaults:{amount:0,retailPricePreference:"retailMarkup"},saveFields:["name","units","vat","purchasePrice","retailPrice","retailMarkup","retailPricePreference","barcode","sku","vendorCountry","vendor","info"]})}),define("collections/products",["require","collections/baseCollection","models/product"],function(e){var t=e("collections/baseCollection"),n=e("models/product");return t.extend({model:n,url:baseApiUrl+"/products"})}),function(){var e=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],t=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,n=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,r=[],i={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},s=function(e,t){var n=i,r="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+e.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(n.interpolate,function(e,t){return"',"+t.replace(/\\'/g,"'")+",'"}).replace(n.evaluate||null,function(e,t){return"');"+t.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"; __p.push('"}).replace(/\r/g,"").replace(/\n/g,"").replace(/\t/g,"")+"');}return __p.join('');";return r};define("tpl",[],function(){var i,o,u;return typeof window!="undefined"&&window.navigator&&window.document?o=function(e,t){var n=i.createXhr();n.open("GET",e,!0),n.onreadystatechange=function(e){n.readyState===4&&t(n.responseText)},n.send(null)}:typeof process!="undefined"&&process.versions&&!!process.versions.node&&(u=require.nodeRequire("fs"),o=function(e,t){t(u.readFileSync(e,"utf8"))}),i={version:"0.24.0",strip:function(e){if(e){e=e.replace(t,"");var r=e.match(n);r&&(e=r[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"").replace(/[\t]/g,"").replace(/[\r]/g,"")},createXhr:function(){var t,n,r;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;for(n=0;n<3;n++){r=e[n];try{t=new ActiveXObject(r)}catch(i){}if(t){e=[r];break}}if(!t)throw new Error("require.getXhr(): XMLHttpRequest not available");return t},get:o,load:function(e,t,n,o){var u=!1,a,f=e.indexOf("."),l=e.substring(0,f),c=e.substring(f+1,e.length);f=c.indexOf("!"),f!==-1&&(u=c.substring(f+1,c.length),u=u==="strip",c=c.substring(0,f)),a="nameToUrl"in t?t.nameToUrl(l,"."+c):t.toUrl(l+"."+c),i.get(a,function(t){t=s(t),o.isBuild||(t=new Function("obj",t)),t=u?i.strip(t):t,o.isBuild&&o.inlineText&&(r[e]=t),n(t)})},write:function(e,t,n){if(t in r){var s=i.jsEscape(r[t]);n("define('"+e+"!"+t+"', function() {return function(obj) { "+s.replace(/(\\')/g,"'").replace(/(\\\\)/g,"\\")+"}});\n")}}}})}(),define("tpl!blocks/balanceList/templates/balanceList.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<table class="balanceList__table table">    ',block.templates.table({block:block}),"</table>");return __p.join("")}}),define("tpl!blocks/balanceList/templates/table.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push("<thead><tr>    <th>Артикул</th>    <th>Название</th>    <th>Производитель</th>    <th>Страна</th>    <th>Средняя ЗЦ</th>    <th>Последняя ЗЦ</th>    <th>Количество</th></tr></thead><tbody>"),_.each(block.productCollection.toJSON(),function(e){__p.push("",block.templates.row({product:e,block:block}),"")}),__p.push("</tbody>");return __p.join("")}}),define("tpl!blocks/balanceList/templates/row.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<tr name="amountItem">    <td>        <span name="sku">',product.sku,'</span>    </td>    <td>        <span name="name">',product.name,'</span>    </td>    <td>        <span name="vendor">',product.vendor,'</span>    </td>    <td>        <span name="vendorCountry">',product.vendorCountry,'</span>    </td>    <td>        <span name="averagePurchasePrice">',product.averagePurchasePrice?LH.helpers.formatPrice(product.averagePurchasePrice)+"р.":"&mdash;",'</span>    </td>    <td>        <span name="lastPurchasePrice">',product.lastPurchasePrice?LH.helpers.formatPrice(product.lastPurchasePrice):LH.helpers.formatPrice(product.purchasePrice),' р.</span>    </td>    <td>        <span name="amount">',product.amount||0,'</span>        <span name="units">',LH.helpers.units(product.units,"smallShort"),"</span>    </td></tr>");return __p.join("")}}),define("blocks/balanceList/balanceList",["require","kit/block","collections/products","tpl!./templates/balanceList.html","tpl!./templates/table.html","tpl!./templates/row.html"],function(e){var t=e("kit/block"),n=e("collections/products");return t.extend({productCollection:new n,className:"balanceList",blockName:"balanceList",templates:{index:e("tpl!./templates/balanceList.html"),table:e("tpl!./templates/table.html"),row:e("tpl!./templates/row.html")},initialize:function(){var e=this;e.render(),e.listenTo(e.productCollection,{reset:function(){e.renderTable()},request:function(){e.$table.find("thead").addClass("preloader_rows")}}),e.productCollection.fetch()},renderTable:function(){var e=this;e.$table.html(e.templates.table({block:e})).find("thead").removeClass("preloader_rows")}})}),define("kit/editor/editor",["require","kit/block"],function(e){var t=e("kit/block");return t.extend({className:"editor",editMode:!1,events:{"click .editor__on":function(e){e.preventDefault();var t=this;t.set("editMode",!0)},"click .editor__off":function(e){e.preventDefault();var t=this;t.set("editMode",!1)}},initialize:function(){var e=this;t.prototype.initialize.call(e),e.set("editMode",e.editMode)},"set:editMode":function(e){var t=this;e?(t.$el.addClass("editor_editMode_on"),t.$el.removeClass("editor_editMode_off")):(t.$el.addClass("editor_editMode_off"),t.$el.removeClass("editor_editMode_on"))}})}),define("tpl!kit/tooltip/templates/tooltip.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="tooltip__content">    ',block.templates.content({block:block}),'</div><!--<div class="tooltip__pointer"></div>-->');return __p.join("")}}),define("tpl!kit/tooltip/templates/content.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push("Tooltip content");return __p.join("")}}),define("kit/tooltip/tooltip",["require","kit/block","tpl!./templates/tooltip.html","tpl!./templates/content.html"],function(e){var t=e("kit/block");return t.extend({$trigger:null,className:"tooltip",blockName:"tooltip",templates:{index:e("tpl!./templates/tooltip.html"),content:e("tpl!./templates/content.html")},initialize:function(){var e=this;e.$el.appendTo("body"),e.render(),$(document).on({click:function(t){e.$trigger&&t.target!=e.$trigger[0]&&e.hide()},keyup:function(t){t.keyCode===27&&e.hide()}})},events:{click:function(e){e.stopPropagation()},"click .tooltip__closeLink":function(e){e.preventDefault();var t=this;t.hide()}},show:function(e){var t=this;e=_.extend({$trigger:null},e),t.$trigger=e.$trigger||t.$trigger,t.$el.css({top:t.$trigger.offset().top+t.$trigger.height(),left:t.$trigger.offset().left}).show()},hide:function(){var e=this;e.$el.hide()}})}),define("kit/form/form",["require","kit/block"],function(e){var t=e("kit/block");return t.extend({tagName:"form",className:"form",model:null,events:{submit:function(e){e.preventDefault();var t=this;t.$submitButton.addClass("preloader preloader_rows"),t.removeErrors(),t.submit().then(function(e){t.trigger("successSubmit",e),t.$submitButton.removeClass("preloader preloader_rows")},function(e){t.showErrors(e),t.$submitButton.removeClass("preloader preloader_rows")})}},findElements:function(){var e=this;t.prototype.findElements.apply(e,arguments),e.$submitButton=e.$el.find('[type="submit"]').closest(".button").add('input[form="'+e.$el.attr("id")+'"]')},submit:function(){var e=this,t=$.Deferred(),n=Backbone.Syphon.serialize(e),r=e.model.id?e.model:e.model.clone();return r.save(n,{success:function(e){t.resolve(e)},error:function(e,n){t.reject(JSON.parse(n.responseText))}}),t.promise()},showErrors:function(e){var t=this;t.removeErrors(),t.$submitButton.removeClass("preloader preloader_rows"),e&&_.each(e.children,function(e,n){var r;e.errors&&(r=e.errors.join(", ")),t.$el.find("[name='"+n+"']").closest(".form__field").attr("lh_field_error",r)})},removeErrors:function(){var e=this;e.$el.find("input, textarea, select").closest(".form__field").removeAttr("lh_field_error")},disable:function(e){var t=this;e?t.$el.find("[type=submit]").closest(".button").addClass("button_disabled"):t.$el.find("[type=submit]").closest(".button").removeClass("button_disabled")},clear:function(){var e=this;e.removeErrors(),e.$submitButton.removeClass("preloader preloader_rows"),e.$el.find(":input").each(function(){switch(this.type){case"password":case"select-multiple":case"select-one":case"text":case"textarea":case"hidden":$(this).val("");break;case"checkbox":case"radio":this.checked=!1}})}})}),define("tpl!blocks/tooltip/templates/tooltip_editMenu.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<ul class="tooltip__controls">    <li class="catalogEditTooltip__controlItem">        <a class="tooltip__controlLink tooltip__editLink">Редактировать</a>    </li>    <li class="tooltip__controlItem">        <a class="tooltip__controlLink tooltip__removeLink">Удалить</a>    </li></ul>');return __p.join("")}}),define("blocks/tooltip/tooltip_editMenu",["require","kit/tooltip/tooltip","tpl!./templates/tooltip_editMenu.html"],function(e){var t=e("kit/tooltip/tooltip");return t.extend({addClass:"tooltip_editMenu",templates:{content:e("tpl!./templates/tooltip_editMenu.html")}})}),define("models/catalogGroup",["require","models/baseModel"],function(e){var t=e("models/baseModel");return t.extend({modelName:"group",urlRoot:baseApiUrl+"/groups",saveFields:["name","klass"]})}),define("tpl!blocks/tooltip/templates/tooltip_editGroup.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<!--    @block.groupModel--><form class="form">    <div class="form__field" style="white-space: nowrap; padding-bottom: 0;">        <input value="',block.groupModel.get("name"),'" style="width: 250px;" class="inputText" type="text" name="name" placeholder="Название группы">        <span class="button button_color_blue">            Подтвердить            <input type="submit">        </span>        <a class="tooltip__closeLink" style="vertical-align: middle">Отмена</a>    </div></form>');return __p.join("")}}),define("blocks/tooltip/tooltip_editGroup",["require","kit/tooltip/tooltip","kit/form/form","models/catalogGroup","tpl!./templates/tooltip_editGroup.html"],function(e){var t=e("kit/tooltip/tooltip"),n=e("kit/form/form"),r=e("models/catalogGroup");return t.extend({groupModel:null,classModel:null,addClass:"tooltip_editGroup",templates:{content:e("tpl!./templates/tooltip_editGroup.html")},initialize:function(){var e=this,i=_.find(e.classModel.get("groups"),function(t){return t.id==e.groupId});e.groupModel=new r(_.extend({klass:e.classModel.id},i)),t.prototype.initialize.call(this),e.form=new n({el:e.el.getElementsByClassName("form"),model:e.groupModel}),e.listenTo(e.groupModel,{change:function(t){e.classModel.set("groups",_.map(e.classModel.get("groups"),function(e){return e.id===t.id?t.toJSON():e}))}}),e.listenTo(e.form,{successSubmit:function(){e.hide()}})},show:function(){var e=this;t.prototype.show.apply(this,arguments),e.form.$el.find('[type="text"]').eq(0).focus()}})}),define("blocks/tooltip/tooltip_editGroupMenu",["require","blocks/tooltip/tooltip_editMenu","blocks/tooltip/tooltip_editGroup","models/catalogGroup"],function(e){var t=e("blocks/tooltip/tooltip_editMenu"),n=e("blocks/tooltip/tooltip_editGroup"),r=e("models/catalogGroup");return t.extend({groupId:null,events:{"click .tooltip__editLink":function(e){e.preventDefault();var t=this,n=$(e.target);t.hide(),t.tooltip_editGroup.show()},"click .tooltip__removeLink":function(e){e.preventDefault();var t=this,n=t.classModel.get("groups"),i=new r({id:t.groupId});i.destroy({success:function(){t.classModel.set("groups",_.reject(n,function(e){return e.id===t.groupId}))}}),t.hide()}},initialize:function(){var e=this;t.prototype.initialize.call(this),e.tooltip_editGroup=new n({$trigger:e.$trigger,classModel:e.classModel,groupId:e.groupId})}})}),define("models/catalogClass",["require","models/baseModel"],function(e){var t=e("models/baseModel");return t.extend({modelName:"klass",urlRoot:baseApiUrl+"/klasses",saveFields:["name"]})}),define("tpl!blocks/tooltip/templates/tooltip_editClass.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<!--    @block.classModel--><form class="form">    <div class="form__field" style="white-space: nowrap; padding-bottom: 0;">        <input value="',block.classModel.get("name"),'" style="width: 250px;" class="inputText" type="text" name="name" placeholder="Название класса">        <span class="button button_color_blue">            Подтвердить            <input type="submit">        </span>        <a class="tooltip__closeLink" style="vertical-align: middle">Отмена</a>    </div></form>');return __p.join("")}}),define("blocks/tooltip/tooltip_editClass",["require","kit/tooltip/tooltip","kit/form/form","models/catalogClass","tpl!./templates/tooltip_editClass.html"],function(e){var t=e("kit/tooltip/tooltip"),n=e("kit/form/form"),r=e("models/catalogClass");return t.extend({classModel:null,addClass:"tooltip_editClass",templates:{content:e("tpl!./templates/tooltip_editClass.html")},initialize:function(){var e=this;e.classModel=e.classModel||new r,t.prototype.initialize.call(this),e.form=new n({el:e.el.getElementsByClassName("form"),model:e.classModel}),e.listenTo(e.form,{successSubmit:function(){e.hide()}})},show:function(){var e=this;t.prototype.show.apply(this,arguments),e.form.$el.find('[type="text"]').eq(0).focus()}})}),define("blocks/tooltip/tooltip_editClassMenu",["require","blocks/tooltip/tooltip_editMenu","blocks/tooltip/tooltip_editClass"],function(e){var t=e("blocks/tooltip/tooltip_editMenu"),n=e("blocks/tooltip/tooltip_editClass");return t.extend({classModel:null,events:{"click .tooltip__editLink":function(e){e.preventDefault();var t=this,n=$(e.target);t.hide(),t.tooltip_editClass.show()},"click .tooltip__removeLink":function(e){e.preventDefault();var t=this;t.classModel.get("groups")&&t.classModel.get("groups").length?alert("Необходимо удалить все группы из класса"):t.classModel.destroy(),t.hide()}},initialize:function(){var e=this;t.prototype.initialize.call(this),e.tooltip_editClass=new n({$trigger:e.$trigger,classModel:e.classModel})}})}),define("kit/content/content",["require","kit/block"],function(e){var t=e("kit/block");return t.extend({className:"content",blockName:"content",load:function(t,n){var r=this;r.clear(),r.$el.addClass("preloader preloader_spinner"),e(["tpl!"+t],function(e){r.$el.html(e(n)).removeClass("preloader preloader_spinner").require()})},clear:function(){var e=this;e.$el.children("[block]").each(function(){$(this).data("block").stopListening()}),e.$el.empty()}})}),define("blocks/content/content_main",["require","kit/content/content"],function(e){var t=e("kit/content/content");return new t({el:document.getElementById("content_main"),blockName:"content_main",addClass:"content_main"})}),define("routers/baseRouter",["require"],function(e){return Backbone.Router.extend({})}),define("routers/catalog",["require","blocks/content/content_main","kit/_utils/deepExtend","routers/baseRouter"],function(e){var t=e("blocks/content/content_main"),n=e("kit/_utils/deepExtend"),r=e("routers/baseRouter"),i=r.extend({params:{editMode:!1},routes:{catalog:"catalog","catalog/:catalogClassId":"catalogClass","catalog/:catalogClassId/:catalogGroupId":"catalogGroup"},open:function(e,r){t.load(e,n({},r,{params:this.params}))},catalog:function(e){this.open("/pages/catalog/catalog.html",{params:e})},catalogClass:function(e,t){this.open("/pages/catalog/class.html",{catalogClassId:e,params:t})},catalogGroup:function(e,t,n){this.open("/pages/catalog/group.html",{catalogClassId:e,catalogGroupId:t,params:n})}});return new i}),define("collections/catalogClasses",["require","collections/baseCollection","models/catalogClass"],function(e){var t=e("collections/baseCollection"),n=e("models/catalogClass");return t.extend({model:n,url:baseApiUrl+"/klasses"})}),define("tpl!blocks/catalog/templates/catalog.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="page__controls">    <a class="page__controlsLink editor__on">Редактировать</a>    <a class="page__controlsLink editor__off">Завершить редактирование</a></div><h3>    <span style="vertical-align: middle; margin-right: 10px;">        Товарный справочник    </span>    <a class="button button_color_blue catalog__addClassLink editor__control">        Добавить класс    </a></h3><div class="catalog__classList"></div>');return __p.join("")}}),define("tpl!blocks/catalog/templates/classList.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push(""),_.each(catalogClasses,function(e){__p.push("    ",block.templates.classItem({block:block,catalogClass:e}),"")}),__p.push("");return __p.join("")}}),define("tpl!blocks/catalog/templates/classItem.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="catalog__classItem" id="',catalogClass.id,'">    <div class="catalog__classTitle">        <a href="/catalog/',catalogClass.id,'" class="catalog__classLink">',catalogClass.name,'</a>        <a classId="',catalogClass.id,'" class="editor__editLink catalog__editClassLink"></a>    </div>    '),catalogClass.groups&&catalogClass.groups.length?__p.push('        <ul class="catalog__classGroupList">            ',block.templates.groupList({block:block,classGroups:catalogClass.groups,catalogClass:catalogClass}),"        </ul>    "):__p.push("        <div>Нет групп</div>    "),__p.push("</div>");return __p.join("")}}),define("tpl!blocks/catalog/templates/groupList.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push(""),_.each(classGroups,function(e){__p.push("    ",block.templates.groupItem({block:block,classGroup:e,catalogClass:catalogClass}),"")}),__p.push("");return __p.join("")}}),define("tpl!blocks/catalog/templates/groupItem.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<li class="catalog__classGroupItem">    <a href="/catalog/',catalogClass.id,"/",classGroup.id,'" class="catalog__groupLink">',classGroup.name,'</a>    <a groupId="',classGroup.id,'" class="editor__editLink catalog__editGroupLink"></a></li>');return __p.join("")}}),define("tpl!blocks/catalog/templates/addClassForm.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="form__field" style="white-space: nowrap; padding-bottom: 0;">    <input style="width: 250px;" class="inputText" type="text" name="name" placeholder="Название класса">    <span style="margin-right: 0" class="button button_color_blue">        Добавить класс        <input type="submit">    </span></div>');return __p.join("")}}),define("blocks/catalog/catalog",["require","kit/editor/editor","kit/tooltip/tooltip","kit/form/form","blocks/tooltip/tooltip_editGroupMenu","blocks/tooltip/tooltip_editClassMenu","routers/catalog","models/catalogClass","collections/catalogClasses","tpl!./templates/catalog.html","tpl!./templates/classList.html","tpl!./templates/classItem.html","tpl!./templates/groupList.html","tpl!./templates/groupItem.html","tpl!./templates/addClassForm.html"],function(e){var t=e("kit/editor/editor"),n=e("kit/tooltip/tooltip"),r=e("kit/form/form"),i=e("blocks/tooltip/tooltip_editGroupMenu"),s=e("blocks/tooltip/tooltip_editClassMenu"),o=e("routers/catalog"),u=e("models/catalogClass"),a=e("collections/catalogClasses");return t.extend({className:"catalog",blockName:"catalog",templates:{index:e("tpl!./templates/catalog.html"),classList:e("tpl!./templates/classList.html"),classItem:e("tpl!./templates/classItem.html"),groupList:e("tpl!./templates/groupList.html"),groupItem:e("tpl!./templates/groupItem.html"),addClassForm:e("tpl!./templates/addClassForm.html")},events:{"click .catalog__addClassLink":function(e){e.preventDefault();var t=this,n=$(e.target);t.addClassTooltip.show({$trigger:n}),t.addClassForm.$el.find('[name="name"]').focus()},"click .catalog__editClassLink":function(e){e.preventDefault();var t=this,n=$(e.target);t.tooltip_editClassMenu&&(t.tooltip_editClassMenu.tooltip_editClass.remove(),t.tooltip_editClassMenu.remove()),t.tooltip_editClassMenu=new s({$trigger:n,classModel:t.catalogClassesCollection.get(n.attr("classId"))}),t.tooltip_editClassMenu.show()},"click .catalog__editGroupLink":function(e){e.preventDefault();var t=this,n=$(e.target);t.tooltip_editGroupMenu&&t.tooltip_editGroupMenu.remove(),t.tooltip_editGroupMenu=new i({$trigger:n,classModel:t.catalogClassesCollection.get(n.closest(".catalog__classItem").attr("id")),groupId:n.attr("groupId")}),t.tooltip_editGroupMenu.show()}},initialize:function(){var e=this;t.prototype.initialize.call(e),e.catalogClassesCollection=new a,e.addClassTooltip=new n({addClass:"catalog__addClassTooltip"}),e.addClassForm=new r({model:new u,templates:{index:e.templates.addClassForm},addClass:"catalog__addClassForm"}),e.addClassTooltip.$content.html(e.addClassForm.$el),e.listenTo(e.catalogClassesCollection,{reset:function(){e.renderClassList()},add:function(t){e.$classList.prepend(e.templates.classItem({block:e,catalogClass:t.toJSON()}))},remove:function(t){e.$el.find("#"+t.get("id")).remove()},change:function(t){e.$el.find("#"+t.get("id")).replaceWith(e.templates.classItem({block:e,catalogClass:t.toJSON()}))}}),e.listenTo(e.addClassForm,{successSubmit:function(t){e.catalogClassesCollection.push(t.toJSON()),e.addClassForm.clear(),e.addClassForm.$el.find('[name="name"]').focus()}}),e.catalogClassesCollection.fetch()},renderClassList:function(){var e=this;e.$classList.html(e.templates.classList({block:e,catalogClasses:e.catalogClassesCollection.toJSON()}))},"set:editMode":function(e){t.prototype["set:editMode"].apply(this,arguments),o.params.editMode=e}})}),define("collections/classGroups",["require","collections/baseCollection","models/catalogGroup"],function(e){var t=e("collections/baseCollection"),n=e("models/catalogGroup");return t.extend({initialize:function(e){this.classId=e.classId},model:n,url:function(){return baseApiUrl+"/klasses/"+this.classId+"/groups"}})}),define("tpl!blocks/catalogClass/templates/catalogClass.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="page__controls">    <a class="page__controlsLink editor__on">Редактировать</a>    <a class="page__controlsLink editor__off">Завершить редактирование</a></div><h3>    <a style="vertical-align: middle" href="/catalog">Товарный справочник</a>    <span style="vertical-align: middle">/</span>    <span class="catalogClass__className" style="vertical-align: middle;"></span>    <a class="editor__editLink catalog__editClassLink"></a>    <a class="button button_color_blue catalog__addGroupLink editor__control">        Добавить группу    </a></h3><div class="catalogClass__rightSide">    <div class="catalogClass__listTitle">        Классы    </div>    <ul class="catalogClass__classList"></ul></div><ul class="catalog__classGroupList catalogClass__groupList"></ul><div style="clear: both"></div>');return __p.join("")}}),define("tpl!blocks/catalogClass/templates/classList.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push(""),block.catalogClassesCollection.each(function(e){__p.push('<li class="catalogClass__listItem">    <a class="catalogClass__listLink" href="/catalog/',e.get("id"),'">',e.get("name"),"</a></li>")}),__p.push("");return __p.join("")}}),define("tpl!blocks/catalogClass/templates/addGroupForm.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="form__field" style="white-space: nowrap; padding-bottom: 0;">    <input style="width: 250px;" class="inputText" type="text" name="name" placeholder="Название группы">    <span style="margin-right: 0" class="button button_color_blue">        Добавить группу        <input type="submit">    </span></div>');return __p.join("")}}),define("blocks/catalogClass/catalogClass",["require","blocks/tooltip/tooltip_editGroupMenu","kit/editor/editor","kit/tooltip/tooltip","models/catalogClass","models/catalogGroup","collections/catalogClasses","collections/classGroups","routers/catalog","blocks/tooltip/tooltip_editClassMenu","kit/form/form","tpl!./templates/catalogClass.html","tpl!blocks/catalog/templates/groupList.html","tpl!blocks/catalog/templates/groupItem.html","tpl!./templates/classList.html","tpl!./templates/addGroupForm.html"],function(e){var t=e("blocks/tooltip/tooltip_editGroupMenu"),n=e("kit/editor/editor"),r=e("kit/tooltip/tooltip"),i=e("models/catalogClass"),s=e("models/catalogGroup"),o=e("collections/catalogClasses"),u=e("collections/classGroups"),a=e("routers/catalog"),f=e("blocks/tooltip/tooltip_editClassMenu"),l=e("kit/form/form");return n.extend({editMode:!1,className:"catalogClass",addClass:"catalog",catalogClassId:null,templates:{index:e("tpl!./templates/catalogClass.html"),groupList:e("tpl!blocks/catalog/templates/groupList.html"),groupItem:e("tpl!blocks/catalog/templates/groupItem.html"),classList:e("tpl!./templates/classList.html"),addGroupForm:e("tpl!./templates/addGroupForm.html")},events:{"click .catalog__addGroupLink":function(e){e.preventDefault();var t=this,n=$(e.target);t.addGroupTooltip.show({$trigger:n}),t.addGroupForm.$el.find('[name="name"]').focus()},"click .catalog__editGroupLink":function(e){e.preventDefault();var n=this,r=$(e.target);n.tooltip_editGroupMenu&&n.tooltip_editGroupMenu.remove(),n.tooltip_editGroupMenu=new t({$trigger:r,classModel:n.catalogClassModel,groupId:r.attr("groupId")}),n.tooltip_editGroupMenu.show()},"click .catalog__editClassLink":function(e){e.preventDefault();var t=this,n=$(e.target);t.tooltip_editClassMenu&&(t.tooltip_editClassMenu.tooltip_editClass.remove(),t.tooltip_editClassMenu.remove()),t.tooltip_editClassMenu=new f({$trigger:n,classModel:t.catalogClassModel}),t.tooltip_editClassMenu.show()}},initialize:function(){var e=this;n.prototype.initialize.call(e),e.catalogClassModel=new i({id:e.catalogClassId}),e.catalogClassesCollection=new o,e.classGroupsCollection=new u({classId:e.catalogClassId}),e.addGroupTooltip=new r({addClass:"catalog__addGroupTooltip"}),e.addGroupForm=new l({model:new s({klass:e.catalogClassId}),templates:{index:e.templates.addGroupForm},addClass:"catalog__addGroupForm"}),e.addGroupTooltip.$content.html(e.addGroupForm.$el),e.listenTo(e.catalogClassModel,{change:function(t,n){e.$className.html(t.get("name")),e.classGroupsCollection.reset(e.catalogClassModel.get("groups")),e.catalogClassesCollection.add(t.toJSON(),{merge:!0}),e.renderClassList()},destroy:function(){a.navigate("/catalog",{trigger:!0})}}),e.listenTo(e.classGroupsCollection,{reset:function(){e.renderGroupList()},change:function(){e.renderGroupList()},add:function(t,n){e.catalogClassModel.set("groups",n.toJSON())}}),e.listenTo(e.catalogClassesCollection,{reset:function(){e.renderClassList()}}),e.listenTo(e.addGroupForm,{successSubmit:function(t){e.classGroupsCollection.push(t),e.addGroupForm.clear(),e.addGroupForm.$el.find('[name="name"]').focus()}}),e.catalogClassModel.fetch(),e.catalogClassesCollection.fetch(),e.classGroupsCollection.fetch()},renderGroupList:function(){var e=this;e.$groupList.html(e.templates.groupList({block:e,classGroups:e.classGroupsCollection.toJSON(),catalogClass:e.catalogClassModel.toJSON()}))},renderClassList:function(){var e=this;e.$classList.html(e.templates.classList({block:e}))},"set:editMode":function(e){n.prototype["set:editMode"].apply(this,arguments),a.params.editMode=e}})}),function(e){function t(e,t){return function(n){return a(e.call(this,n),t)}}function n(e){return function(t){return this.lang().ordinal(e.call(this,t))}}function r(){}function i(e){o(this,e)}function s(e){var t=this._data={},n=e.years||e.year||e.y||0,r=e.months||e.month||e.M||0,i=e.weeks||e.week||e.w||0,s=e.days||e.day||e.d||0,o=e.hours||e.hour||e.h||0,a=e.minutes||e.minute||e.m||0,f=e.seconds||e.second||e.s||0,l=e.milliseconds||e.millisecond||e.ms||0;this._milliseconds=l+f*1e3+a*6e4+o*36e5,this._days=s+i*7,this._months=r+n*12,t.milliseconds=l%1e3,f+=u(l/1e3),t.seconds=f%60,a+=u(f/60),t.minutes=a%60,o+=u(a/60),t.hours=o%24,s+=u(o/24),s+=i*7,t.days=s%30,r+=u(s/30),t.months=r%12,n+=u(r/12),t.years=n}function o(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function u(e){return e<0?Math.ceil(e):Math.floor(e)}function a(e,t){var n=e+"";while(n.length<t)n="0"+n;return n}function f(e,t,n){var r=t._milliseconds,i=t._days,s=t._months,o;r&&e._d.setTime(+e+r*n),i&&e.date(e.date()+i*n),s&&(o=e.date(),e.date(1).month(e.month()+s*n).date(Math.min(o,e.daysInMonth())))}function l(e){return Object.prototype.toString.call(e)==="[object Array]"}function c(e,t){var n=Math.min(e.length,t.length),r=Math.abs(e.length-t.length),i=0,s;for(s=0;s<n;s++)~~e[s]!==~~t[s]&&i++;return i+r}function h(e,t){return t.abbr=e,H[e]||(H[e]=new r),H[e].set(t),H[e]}function p(e){return e?(!H[e]&&B&&require("./lang/"+e),H[e]):M.fn._lang}function d(e){return e.match(/\[.*\]/)?e.replace(/^\[|\]$/g,""):e.replace(/\\/g,"")}function v(e){var t=e.match(F),n,r;for(n=0,r=t.length;n<r;n++)st[t[n]]?t[n]=st[t[n]]:t[n]=d(t[n]);return function(i){var s="";for(n=0;n<r;n++)s+=typeof t[n].call=="function"?t[n].call(i,e):t[n];return s}}function m(e,t){function n(t){return e.lang().longDateFormat(t)||t}var r=5;while(r--&&I.test(t))t=t.replace(I,n);return nt[t]||(nt[t]=v(t)),nt[t](e)}function g(e){switch(e){case"DDDD":return z;case"YYYY":return W;case"YYYYY":return X;case"S":case"SS":case"SSS":case"DDD":return U;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":case"a":case"A":return V;case"X":return K;case"Z":case"ZZ":return $;case"T":return J;case"MM":case"DD":case"YY":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":return R;default:return new RegExp(e.replace("\\",""))}}function y(e,t,n){var r,i,s=n._a;switch(e){case"M":case"MM":s[1]=t==null?0:~~t-1;break;case"MMM":case"MMMM":r=p(n._l).monthsParse(t),r!=null?s[1]=r:n._isValid=!1;break;case"D":case"DD":case"DDD":case"DDDD":t!=null&&(s[2]=~~t);break;case"YY":s[0]=~~t+(~~t>68?1900:2e3);break;case"YYYY":case"YYYYY":s[0]=~~t;break;case"a":case"A":n._isPm=(t+"").toLowerCase()==="pm";break;case"H":case"HH":case"h":case"hh":s[3]=~~t;break;case"m":case"mm":s[4]=~~t;break;case"s":case"ss":s[5]=~~t;break;case"S":case"SS":case"SSS":s[6]=~~(("0."+t)*1e3);break;case"X":n._d=new Date(parseFloat(t)*1e3);break;case"Z":case"ZZ":n._useUTC=!0,r=(t+"").match(Z),r&&r[1]&&(n._tzh=~~r[1]),r&&r[2]&&(n._tzm=~~r[2]),r&&r[0]==="+"&&(n._tzh=-n._tzh,n._tzm=-n._tzm)}t==null&&(n._isValid=!1)}function b(e){var t,n,r=[];if(e._d)return;for(t=0;t<7;t++)e._a[t]=r[t]=e._a[t]==null?t===2?1:0:e._a[t];r[3]+=e._tzh||0,r[4]+=e._tzm||0,n=new Date(0),e._useUTC?(n.setUTCFullYear(r[0],r[1],r[2]),n.setUTCHours(r[3],r[4],r[5],r[6])):(n.setFullYear(r[0],r[1],r[2]),n.setHours(r[3],r[4],r[5],r[6])),e._d=n}function w(e){var t=e._f.match(F),n=e._i,r,i;e._a=[];for(r=0;r<t.length;r++)i=(g(t[r]).exec(n)||[])[0],i&&(n=n.slice(n.indexOf(i)+i.length)),st[t[r]]&&y(t[r],i,e);e._isPm&&e._a[3]<12&&(e._a[3]+=12),e._isPm===!1&&e._a[3]===12&&(e._a[3]=0),b(e)}function E(e){var t,n,r,s=99,u,a,f;while(e._f.length){t=o({},e),t._f=e._f.pop(),w(t),n=new i(t);if(n.isValid()){r=n;break}f=c(t._a,n.toArray()),f<s&&(s=f,r=n)}o(e,r)}function S(e){var t,n=e._i;if(Q.exec(n)){e._f="YYYY-MM-DDT";for(t=0;t<4;t++)if(Y[t][1].exec(n)){e._f+=Y[t][0];break}$.exec(n)&&(e._f+=" Z"),w(e)}else e._d=new Date(n)}function x(t){var n=t._i,r=j.exec(n);n===e?t._d=new Date:r?t._d=new Date(+r[1]):typeof n=="string"?S(t):l(n)?(t._a=n.slice(0),b(t)):t._d=n instanceof Date?new Date(+n):new Date(n)}function T(e,t,n,r,i){return i.relativeTime(t||1,!!n,e,r)}function N(e,t,n){var r=D(Math.abs(e)/1e3),i=D(r/60),s=D(i/60),o=D(s/24),u=D(o/365),a=r<45&&["s",r]||i===1&&["m"]||i<45&&["mm",i]||s===1&&["h"]||s<22&&["hh",s]||o===1&&["d"]||o<=25&&["dd",o]||o<=45&&["M"]||o<345&&["MM",D(o/30)]||u===1&&["y"]||["yy",u];return a[2]=t,a[3]=e>0,a[4]=n,T.apply({},a)}function C(e,t,n){var r=n-t,i=n-e.day();return i>r&&(i-=7),i<r-7&&(i+=7),Math.ceil(M(e).add("d",i).dayOfYear()/7)}function k(e){var t=e._i,n=e._f;return t===null||t===""?null:(typeof t=="string"&&(e._i=t=p().preparse(t)),M.isMoment(t)?(e=o({},t),e._d=new Date(+t._d)):n?l(n)?E(e):w(e):x(e),new i(e))}function L(e,t){M.fn[e]=M.fn[e+"s"]=function(e){var n=this._isUTC?"UTC":"";return e!=null?(this._d["set"+n+t](e),this):this._d["get"+n+t]()}}function A(e){M.duration.fn[e]=function(){return this._data[e]}}function O(e,t){M.duration.fn["as"+e]=function(){return+this/t}}var M,_="2.0.0",D=Math.round,P,H={},B=typeof module!="undefined"&&module.exports,j=/^\/?Date\((\-?\d+)/i,F=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,I=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,q=/([0-9a-zA-Z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)/gi,R=/\d\d?/,U=/\d{1,3}/,z=/\d{3}/,W=/\d{1,4}/,X=/[+\-]?\d{1,6}/,V=/[0-9]*[a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF]+\s*?[\u0600-\u06FF]+/i,$=/Z|[\+\-]\d\d:?\d\d/i,J=/T/i,K=/[\+\-]?\d+(\.\d{1,3})?/,Q=/^\s*\d{4}-\d\d-\d\d((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/,G="YYYY-MM-DDTHH:mm:ssZ",Y=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],Z=/([\+\-]|\d\d)/gi,et="Month|Date|Hours|Minutes|Seconds|Milliseconds".split("|"),tt={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},nt={},rt="DDD w W M D d".split(" "),it="M D H h m s w W".split(" "),st={M:function(){return this.month()+1},MMM:function(e){return this.lang().monthsShort(this,e)},MMMM:function(e){return this.lang().months(this,e)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(e){return this.lang().weekdaysMin(this,e)},ddd:function(e){return this.lang().weekdaysShort(this,e)},dddd:function(e){return this.lang().weekdays(this,e)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return a(this.year()%100,2)},YYYY:function(){return a(this.year(),4)},YYYYY:function(){return a(this.year(),5)},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return~~(this.milliseconds()/100)},SS:function(){return a(~~(this.milliseconds()/10),2)},SSS:function(){return a(this.milliseconds(),3)},Z:function(){var e=-this.zone(),t="+";return e<0&&(e=-e,t="-"),t+a(~~(e/60),2)+":"+a(~~e%60,2)},ZZ:function(){var e=-this.zone(),t="+";return e<0&&(e=-e,t="-"),t+a(~~(10*e/6),4)},X:function(){return this.unix()}};while(rt.length)P=rt.pop(),st[P+"o"]=n(st[P]);while(it.length)P=it.pop(),st[P+P]=t(st[P],2);st.DDDD=t(st.DDD,3),r.prototype={set:function(e){var t,n;for(n in e)t=e[n],typeof t=="function"?this[n]=t:this["_"+n]=t},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(e){return this._months[e.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(e){return this._monthsShort[e.month()]},monthsParse:function(e){var t,n,r,i;this._monthsParse||(this._monthsParse=[]);for(t=0;t<12;t++){this._monthsParse[t]||(n=M([2e3,t]),r="^"+this.months(n,"")+"|^"+this.monthsShort(n,""),this._monthsParse[t]=new RegExp(r.replace(".",""),"i"));if(this._monthsParse[t].test(e))return t}},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(e){return this._weekdays[e.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(e){return this._weekdaysShort[e.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(e){return this._weekdaysMin[e.day()]},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(e){var t=this._longDateFormat[e];return!t&&this._longDateFormat[e.toUpperCase()]&&(t=this._longDateFormat[e.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(e){return e.slice(1)}),this._longDateFormat[e]=t),t},meridiem:function(e,t,n){return e>11?n?"pm":"PM":n?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},calendar:function(e,t){var n=this._calendar[e];return typeof n=="function"?n.apply(t):n},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(e,t,n,r){var i=this._relativeTime[n];return typeof i=="function"?i(e,t,n,r):i.replace(/%d/i,e)},pastFuture:function(e,t){var n=this._relativeTime[e>0?"future":"past"];return typeof n=="function"?n(t):n.replace(/%s/i,t)},ordinal:function(e){return this._ordinal.replace("%d",e)},_ordinal:"%d",preparse:function(e){return e},postformat:function(e){return e},week:function(e){return C(e,this._week.dow,this._week.doy)},_week:{dow:0,doy:6}},M=function(e,t,n){return k({_i:e,_f:t,_l:n,_isUTC:!1})},M.utc=function(e,t,n){return k({_useUTC:!0,_isUTC:!0,_l:n,_i:e,_f:t})},M.unix=function(e){return M(e*1e3)},M.duration=function(e,t){var n=M.isDuration(e),r=typeof e=="number",i=n?e._data:r?{}:e,o;return r&&(t?i[t]=e:i.milliseconds=e),o=new s(i),n&&e.hasOwnProperty("_lang")&&(o._lang=e._lang),o},M.version=_,M.defaultFormat=G,M.lang=function(e,t){var n;if(!e)return M.fn._lang._abbr;t?h(e,t):H[e]||p(e),M.duration.fn._lang=M.fn._lang=p(e)},M.langData=function(e){return e&&e._lang&&e._lang._abbr&&(e=e._lang._abbr),p(e)},M.isMoment=function(e){return e instanceof i},M.isDuration=function(e){return e instanceof s},M.fn=i.prototype={clone:function(){return M(this)},valueOf:function(){return+this._d},unix:function(){return Math.floor(+this._d/1e3)},toString:function(){return this.format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._d},toJSON:function(){return M.utc(this).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var e=this;return[e.year(),e.month(),e.date(),e.hours(),e.minutes(),e.seconds(),e.milliseconds()]},isValid:function(){return this._isValid==null&&(this._a?this._isValid=!c(this._a,(this._isUTC?M.utc(this._a):M(this._a)).toArray()):this._isValid=!isNaN(this._d.getTime())),!!this._isValid},utc:function(){return this._isUTC=!0,this},local:function(){return this._isUTC=!1,this},format:function(e){var t=m(this,e||M.defaultFormat);return this.lang().postformat(t)},add:function(e,t){var n;return typeof e=="string"?n=M.duration(+t,e):n=M.duration(e,t),f(this,n,1),this},subtract:function(e,t){var n;return typeof e=="string"?n=M.duration(+t,e):n=M.duration(e,t),f(this,n,-1),this},diff:function(e,t,n){var r=this._isUTC?M(e).utc():M(e).local(),i=(this.zone()-r.zone())*6e4,s,o;return t&&(t=t.replace(/s$/,"")),t==="year"||t==="month"?(s=(this.daysInMonth()+r.daysInMonth())*432e5,o=(this.year()-r.year())*12+(this.month()-r.month()),o+=(this-M(this).startOf("month")-(r-M(r).startOf("month")))/s,t==="year"&&(o/=12)):(s=this-r-i,o=t==="second"?s/1e3:t==="minute"?s/6e4:t==="hour"?s/36e5:t==="day"?s/864e5:t==="week"?s/6048e5:s),n?o:u(o)},from:function(e,t){return M.duration(this.diff(e)).lang(this.lang()._abbr).humanize(!t)},fromNow:function(e){return this.from(M(),e)},calendar:function(){var e=this.diff(M().startOf("day"),"days",!0),t=e<-6?"sameElse":e<-1?"lastWeek":e<0?"lastDay":e<1?"sameDay":e<2?"nextDay":e<7?"nextWeek":"sameElse";return this.format(this.lang().calendar(t,this))},isLeapYear:function(){var e=this.year();return e%4===0&&e%100!==0||e%400===0},isDST:function(){return this.zone()<M([this.year()]).zone()||this.zone()<M([this.year(),5]).zone()},day:function(e){var t=this._isUTC?this._d.getUTCDay():this._d.getDay();return e==null?t:this.add({d:e-t})},startOf:function(e){e=e.replace(/s$/,"");switch(e){case"year":this.month(0);case"month":this.date(1);case"week":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return e==="week"&&this.day(0),this},endOf:function(e){return this.startOf(e).add(e.replace(/s?$/,"s"),1).subtract("ms",1)},isAfter:function(e,t){return t=typeof t!="undefined"?t:"millisecond",+this.clone().startOf(t)>+M(e).startOf(t)},isBefore:function(e,t){return t=typeof t!="undefined"?t:"millisecond",+this.clone().startOf(t)<+M(e).startOf(t)},isSame:function(e,t){return t=typeof t!="undefined"?t:"millisecond",+this.clone().startOf(t)===+M(e).startOf(t)},zone:function(){return this._isUTC?0:this._d.getTimezoneOffset()},daysInMonth:function(){return M.utc([this.year(),this.month()+1,0]).date()},dayOfYear:function(e){var t=D((M(this).startOf("day")-M(this).startOf("year"))/864e5)+1;return e==null?t:this.add("d",e-t)},isoWeek:function(e){var t=C(this,1,4);return e==null?t:this.add("d",(e-t)*7)},week:function(e){var t=this.lang().week(this);return e==null?t:this.add("d",(e-t)*7)},lang:function(t){return t===e?this._lang:(this._lang=p(t),this)}};for(P=0;P<et.length;P++)L(et[P].toLowerCase().replace(/s$/,""),et[P]);L("year","FullYear"),M.fn.days=M.fn.day,M.fn.weeks=M.fn.week,M.fn.isoWeeks=M.fn.isoWeek,M.duration.fn=s.prototype={weeks:function(){return u(this.days()/7)},valueOf:function(){return this._milliseconds+this._days*864e5+this._months*2592e6},humanize:function(e){var t=+this,n=N(t,!e,this.lang());return e&&(n=this.lang().pastFuture(t,n)),this.lang().postformat(n)},lang:M.fn.lang};for(P in tt)tt.hasOwnProperty(P)&&(O(P,tt[P]),A(P.toLowerCase()));O("Weeks",6048e5),M.lang("en",{ordinal:function(e){var t=e%10,n=~~(e%100/10)===1?"th":t===1?"st":t===2?"nd":t===3?"rd":"th";return e+n}}),B&&(module.exports=M),typeof ender=="undefined"&&(this.moment=M),typeof define=="function"&&define.amd&&define("moment",[],function(){return M})}.call(this),define("moment/moment.min",function(){}),function(e,t){typeof define=="function"&&define.amd?define("moment/ru",["moment"],t):e.moment=t(e.moment)}(this,function(e){function n(e,n){var r=e.split("_"),i=Math.min(t.length,r.length),s=-1;while(++s<i)if(t[s](n))return r[s];return r[i-1]}function r(e,t,r){var i={mm:"минута_минуты_минут_минуты",hh:"час_часа_часов_часа",dd:"день_дня_дней_дня",MM:"месяц_месяца_месяцев_месяца",yy:"год_года_лет_года"};return r==="m"?t?"минута":"минуту":e+" "+n(i[r],+e)}function i(e,t){var n={nominative:"январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_"),accusative:"января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря".split("_")},r=/D[oD]? *MMMM?/.test(t)?"accusative":"nominative";return n[r][e.month()]}function s(e,t){var n={nominative:"воскресенье_понедельник_вторник_среда_четверг_пятница_суббота".split("_"),accusative:"воскресенье_понедельник_вторник_среду_четверг_пятницу_субботу".split("_")},r=/\[ ?[Вв] ?(?:прошлую|следующую)? ?\] ?dddd/.test(t)?"accusative":"nominative";return n[r][e.day()]}var t=[function(e){return e%10===1&&e%100!==11},function(e){return e%10>=2&&e%10<=4&&e%10%1===0&&(e%100<12||e%100>14)},function(e){return e%10===0||e%10>=5&&e%10<=9&&e%10%1===0||e%100>=11&&e%100<=14&&e%100%1===0},function(e){return!0}];return e.lang("ru",{months:i,monthsShort:"янв_фев_мар_апр_май_июн_июл_авг_сен_окт_ноя_дек".split("_"),weekdays:s,weekdaysShort:"вск_пнд_втр_срд_чтв_птн_сбт".split("_"),weekdaysMin:"вс_пн_вт_ср_чт_пт_сб".split("_"),longDateFormat:{LT:"HH:mm",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., LT",LLLL:"dddd, D MMMM YYYY г., LT"},calendar:{sameDay:"[Сегодня в] LT",nextDay:"[Завтра в] LT",lastDay:"[Вчера в] LT",nextWeek:function(){return this.day()===2?"[Во] dddd [в] LT":"[В] dddd [в] LT"},lastWeek:function(){switch(this.day()){case 0:return"[В прошлое] dddd [в] LT";case 1:case 2:case 4:return"[В прошлый] dddd [в] LT";case 3:case 5:case 6:return"[В прошлую] dddd [в] LT"}},sameElse:"L"},relativeTime:{future:"через %s",past:"%s назад",s:"несколько секунд",m:r,mm:r,h:"час",hh:r,d:"день",dd:r,M:"месяц",MM:r,y:"год",yy:r},ordinal:"%d.",week:{dow:1,doy:7}}),e}),define("tpl!kit/datepicker/templates/datepicker.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="datepicker__controlLinks">    <a class="datepicker__prevMonthLink">пред</a>    <a class="datepicker__nextMonthLink">след</a></div><div class="datepicker__header">    ',block.templates.header({block:block}),'</div><div class="datepicker__daysOfWeek">    <div class="datepicker__dayOfWeek">        ',moment().day(1).format("dd"),'    </div>    <div class="datepicker__dayOfWeek">        ',moment().day(2).format("dd"),'    </div>    <div class="datepicker__dayOfWeek">        ',moment().day(3).format("dd"),'    </div>    <div class="datepicker__dayOfWeek">        ',moment().day(4).format("dd"),'    </div>    <div class="datepicker__dayOfWeek">        ',moment().day(5).format("dd"),'    </div>    <div class="datepicker__dayOfWeek">        ',moment().day(6).format("dd"),'    </div>    <div class="datepicker__dayOfWeek">        ',moment().day(7).format("dd"),'    </div></div><div class="datepicker__dateList">    ',block.templates.dateList({block:block}),'</div><div class="datepicker__timeControls">    <span class="datepicker__timeControlsLabel">Время:</span>    <input placeholder="часы" name="hours" type="text" class="inputText" value="',block.selectedDate?moment(block.selectedDate).format("HH"):"",'" ',block.selectedDate?"":"disabled",' />    <span class="datepicker__timeControlsSpacer">:</span>    <input placeholder="мин" name="minutes" type="text" class="inputText" value="',block.selectedDate?moment(block.selectedDate).format("mm"):"",'" ',block.selectedDate?"":"disabled",' /></div><div class="datepicker__controls">    ',block.templates.controls({block:block}),"</div>");return __p.join("")}}),define("tpl!kit/datepicker/templates/controls.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<a class="button button_color_blue datepicker__saveLink">Сохранить</a><a class="button datepicker__setNowLink datepicker__showNowLink">Сейчас</a>');return __p.join("")}}),define("tpl!kit/datepicker/templates/dateList.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push(""),_.each(block.dateList,function(e){__p.push('    <div data-date="',e.moment.valueOf(),'" class="datepicker__dateItem ',e.isOtherMonth?"datepicker__dateItem_otherMonth":""," ",e.isNow?"datepicker__dateItem_now":""," ",e.isSelected?"datepicker__dateItem_selected":"",'">        ',e.moment.format("DD"),"    </div>")}),__p.push("");return __p.join("")}}),define("tpl!kit/datepicker/templates/header.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<span class="datepicker__monthName">',moment(block.visibleDate).format("MMMM"),'</span><span class="datepicker__yearNum">',moment(block.visibleDate).format("YYYY"),"</span>");return __p.join("")}}),define("kit/datepicker/datepicker",["require","kit/block","moment","moment/ru","tpl!./templates/datepicker.html","tpl!./templates/controls.html","tpl!./templates/dateList.html","tpl!./templates/header.html"],function(e){var t=e("kit/block"),n=e("moment");return e("moment/ru"),n.lang("ru"),t.extend({visibleDate:n().valueOf(),selectedDate:null,noTime:!1,dateList:[],className:"datepicker",tagName:"div",templates:{index:e("tpl!./templates/datepicker.html"),controls:e("tpl!./templates/controls.html"),dateList:e("tpl!./templates/dateList.html"),header:e("tpl!./templates/header.html")},initialize:function(){var e=this;e.dateList.length||e._generateDateList(),e.$el.toggleClass("datepicker_noTime",e.noTime),e.render()},events:{"click .datepicker__saveLink":function(e){e.preventDefault();var t=this;t.trigger("save")},"click .datepicker__closeLink":function(e){e.preventDefault();var t=this;t.trigger("close")},"click .datepicker__setNowLink":function(e){e.preventDefault();var t=this;t.set("selectedDate",n().valueOf())},"click .datepicker__nextMonthLink":function(e){e.preventDefault();var t=this;t.showNextMonth()},"click .datepicker__prevMonthLink":function(e){e.preventDefault();var t=this;t.showPrevMonth()},"click .datepicker__showNowLink":function(e){e.preventDefault();var t=this;t.showNow()},"click .datepicker__dateItem":function(e){e.preventDefault();var t=this,r=n(+$(e.target).data("date"));t.noTime||t.$el.find(".datepicker__timeControls .inputText").each(function(){r[$(this).attr("name")]($(this).val()||0)}),t.set("selectedDate",r.valueOf())},"change .datepicker__timeControls .inputText":function(e){e.preventDefault();var t=this,r=n(t.selectedDate)[$(e.target).attr("name")]($(e.target).val()).valueOf();t.set("selectedDate",r,{renderTimeControls:!1})}},"set:noTime":function(e){var t=this;t.$el.toggleClass("datepicker_noTime",e)},"set:lang":function(e){var t=this;t.moment.lang(e),t.render()},"set:visibleDate":function(e){var t=this;t.visibleDate=e,t._generateDateList()._renderHeader()._renderDateList()},"set:selectedDate":function(e,t){var r=this;if(!e){r._clearSelectedDate();return}t=_.extend({renderTimeControls:!r.noTime},t),r.$el.find(".datepicker__timeControls .inputText").removeAttr("disabled"),r.$el.find(".datepicker__dateItem_selected").removeClass("datepicker__dateItem_selected"),r.$el.find('.datepicker__dateItem[data-date="'+n(e).startOf("day").valueOf()+'"]').addClass("datepicker__dateItem_selected"),t.renderTimeControls&&(r.$el.find('.datepicker__timeControls [name="hours"]').val(n(e).format("HH")),r.$el.find('.datepicker__timeControls [name="minutes"]').val(n(e).format("mm")),r.$el.find('.datepicker__timeControls [name="seconds"]').val(n(e).format("ss")))},showNextMonth:function(){var e=this;e.set("visibleDate",n(e.visibleDate).add("months",1).valueOf())},showPrevMonth:function(){var e=this;e.set("visibleDate",n(e.visibleDate).subtract("months",1).valueOf())},showNow:function(){var e=this;e.set("visibleDate",n().valueOf())},_clearSelectedDate:function(){var e=this;e.$el.find(".datepicker__timeControls .inputText").val("").attr("disabled",!0),e.$el.find(".datepicker__dateItem_selected").removeClass("datepicker__dateItem_selected")},_generateDateList:function(){var e=this,t=n(e.visibleDate),r=n(e.visibleDate).startOf("month").startOf("week").day(1),i=n(e.visibleDate).endOf("month").endOf("week").day(7),s,o;i.date()==7&&i.day(-7),r.date()==2&&r.day(-6),s=i.diff(r,"days"),e.dateList=[];for(var u=0;u<=s;u++)o=n(r).add("days",u),e.dateList.push({moment:o,isOtherMonth:!t.isSame(o,"month"),isNow:n().isSame(o,"day"),isSelected:e.selectedDate?n(e.selectedDate).isSame(o,"day"):!1});return e},_renderDateList:function(){var e=this;return e.$dateList.html(e.templates.dateList({block:e})),e},_renderHeader:function(){var e=this;return e.$header.html(e.templates.header({block:e})),e}})}),define("tpl!kit/inputDate/templates/datepicker__controls.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<a class="button button_color_blue datepicker__saveLink tooltip__closeLink">Закрыть</a><a class="button datepicker__setNowLink datepicker__showNowLink">Сейчас</a>');return __p.join("")}}),define("kit/inputDate/inputDate",["require","kit/block","kit/datepicker/datepicker","kit/tooltip/tooltip","tpl!./templates/datepicker__controls.html"],function(e){var t=e("kit/block"),n=e("kit/datepicker/datepicker"),r=e("kit/tooltip/tooltip");return t.extend({date:null,noTime:!1,tagName:"input",className:"inputDate",templates:{datepicker__controls:e("tpl!./templates/datepicker__controls.html")},initialize:function(){var e=this;e.noTime?(e.$el.mask("99.99.9999"),e.dateFormat="DD.MM.YYYY"):(e.$el.mask("99.99.9999 99:99"),e.dateFormat="DD.MM.YYYY HH:mm"),e.tooltip=new r({$trigger:e.$el}),e.datepicker=new n({templates:{controls:e.templates.datepicker__controls},noTime:e.noTime}),e.tooltip.$el.addClass("inputDate__tooltip"),e.datepicker.$el.attr({rel:e.$el.attr("name")}),e.tooltip.$content.html(e.datepicker.$el),e.$el.change(),e.listenTo(e.datepicker,{"set:selectedDate":function(t){e.set("date",t,{updateDatepicker:!1})}})},"set:date":function(e,t){var n=this;t=_.extend({updateInput:!0,updateDatepicker:!0},t),t.updateInput&&n.$el.val(e?moment(e).format(n.dateFormat):""),t.updateDatepicker&&n.datepicker.set("selectedDate",e)},events:{focus:function(e){var t=this;t.showDatePicker()},change:function(e){var t=this,n=moment(t.$el.val(),t.dateFormat);n&&t.set("date",n.valueOf(),{updateInput:!1})}},showDatePicker:function(){var e=this;e.tooltip.show()}})}),define("models/invoice",["require","models/baseModel"],function(e){var t=e("models/baseModel");return t.extend({modelName:"invoice",urlRoot:baseApiUrl+"/invoices",dateFormat:"dd.mm.yy",datePrintFormat:"dd.mm.yyyy",timeFormat:"HH:mm",invalidMessage:"Вы ввели неверную дату",saveFields:["sku","supplier","acceptanceDate","accepter","legalEntity","supplierInvoiceSku","supplierInvoiceDate"]})}),define("models/invoiceProduct",["require","models/baseModel"],function(e){var t=e("models/baseModel");return t.extend({modelName:"invoiceProduct",urlRoot:function(){return baseApiUrl+"/invoices/"+this.get("invoice").id+"/products"},saveFields:["product","quantity","price"]})}),define("collections/invoiceProducts",["require","collections/baseCollection","models/invoiceProduct"],function(e){var t=e("collections/baseCollection"),n=e("models/invoiceProduct");return t.extend({initialize:function(e){this.invoiceId=e.invoiceId},model:n,url:function(){return baseApiUrl+"/invoices/"+this.invoiceId+"/products"}})}),define("blocks/invoice/addProductForm",["require","kit/form/form","models/invoiceProduct"],function(e){var t=e("kit/form/form"),n=e("models/invoiceProduct");return t.extend({invoiceId:null,initialize:function(){var e=this;e.autocompleteToInput(e.$el.find("[lh_product_autocomplete='name']")),e.autocompleteToInput(e.$el.find("[lh_product_autocomplete='sku']")),e.autocompleteToInput(e.$el.find("[lh_product_autocomplete='barcode']"))},submit:function(){var e=this,t=$.Deferred(),r=Backbone.Syphon.serialize(e),i=new n({invoice:{id:e.invoiceId}});return i.save(r,{error:function(e,n){t.reject(JSON.parse(n.responseText))},success:function(e){t.resolve(e)}}),t.promise()},showErrors:function(e){var t=this;t.removeErrors(),_.each(e.children,function(e,n){var r;if(e.errors){r=e.errors.join(", ");if(n=="product"){var i;t.$el.find("[lh_product_autocomplete='barcode']").val()?i="barcode":t.$el.find("[lh_product_autocomplete='sku']").val()?i="sku":i="name",t.$el.find("[lh_product_autocomplete='"+i+"']").closest(".form__field").attr("lh_field_error",r)}else t.$el.find("[name='"+n+"']").closest(".form__field").attr("lh_field_error",r)}})},autocompleteToInput:function(e){var t=e.attr("lh_product_autocomplete");e.autocomplete({source:function(e,n){$.ajax({url:baseApiUrl+"/products/"+t+"/search.json",dataType:"json",data:{query:e.term},success:function(e){n($.map(e,function(e){return{label:e[t],product:e}}))}})},minLength:3,select:function(e,t){$(this).parents("form").find("[lh_product_autocomplete='name']").val(t.item.product.name),$(this).parents("form").find("[lh_product_autocomplete='sku']").val(t.item.product.sku),$(this).parents("form").find("[lh_product_autocomplete='barcode']").val(t.item.product.barcode),$(this).parents("form").find("[name='product']").val(t.item.product.id),$(this).parents("form").find("[name='quantity']").focus()}}),e.keyup(function(e){var n=$.ui.keyCode;switch(e.keyCode){case n.PAGE_UP:case n.PAGE_DOWN:case n.UP:case n.DOWN:case n.ENTER:case n.NUMPAD_ENTER:case n.TAB:case n.LEFT:case n.RIGHT:case n.ESCAPE:return;default:var r=$(this).autocomplete("getTerm");if(r!=$(this).val()){var i=["name","sku","barcode"];for(var s in i)i[s]!=t&&$(this).parents("form").find("[lh_product_autocomplete='"+i[s]+"']").val("").trigger("input");$(this).parents("form").find("[name='product']").val("")}}})}})}),define("tpl!blocks/invoice/templates/invoice.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="page__controls">    <a class="page__controlsLink invoice__editLink">Редактировать</a>    <a class="page__controlsLink invoice__stopEditLink">Завершить редактирование</a></div><div class="invoice__content">    <div class="invoice__head">    </div>    <table class="invoice__table table">    </table>    <div class="invoice__footer">    </div></div><div class="page__clear"></div><form class="form invoice__addProductForm">    <h3>Добавить товар в накладную</h3>    <input type="hidden" name="product">    <div class="form__field form__field_inline">        <label class="form__label">Наименование</label>        <input class="inputText" type="text" lh_product_autocomplete="name"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Артикул</label>        <input class="inputText" type="text" lh_product_autocomplete="sku"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Штрихкод</label>        <input class="inputText" type="text" lh_product_autocomplete="barcode"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Количество</label>        <input class="inputText" type="text" name="quantity"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Цена приёмки</label>        <input class="inputText" type="text" name="price"/>    </div>    <div class="form__controls">        <span class="button button_color_blue invoice__addMoreProduct">            Добавить товар            <input type="submit"/>        </span>        <a class="button invoice__stopEditButton">            Завершить редактирование        </a>    </div></form>');return __p.join("")}}),define("tpl!blocks/invoice/templates/dataInput.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<form class="invoice__dataInput">    <input class="inputText"           type="text"           name="',$dataElement.attr("model-attr"),'"           value="',_.escape($.trim($dataElement.html())),'"/>    <input type="submit" /></form>');return __p.join("")}}),define("tpl!blocks/invoice/templates/dataInputAutocomplete.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<form class="invoice__dataInput">    <input class="inputText"           type="text"           lh_product_autocomplete="',$dataElement.attr("autocomplete-name"),'"           value="',_.escape($.trim($dataElement.html())),'"/>    <input type="submit" />    <input type="hidden"           name="',$dataElement.attr("model-attr"),'"           value="',$dataElement.attr("product-id"),'" /></form>');return __p.join("")}}),define("tpl!blocks/invoice/templates/dataInputControls.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="invoice__dataInputControls">    <a class="button invoice__dataInputSave">        Сохранить    </a>    <span style="vertical-align: middle">    или    <a class="invoice__dataInputCancel">отменить изменения</a>    </span></div>');return __p.join("")}}),define("tpl!blocks/invoice/templates/footer.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('Итого<span name="totalProducts" class="invoice__totalProducts">',block.invoiceModel.get("itemsCount"),'</span>позиций на сумму<span name="totalSum" class="invoice__totalSum">',LH.helpers.formatPrice(block.invoiceModel.get("sumTotal")),"</span>рублей");return __p.join("")}}),define("tpl!blocks/invoice/templates/head.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="invoice__title invoice__dataRow">    Накладная    <span class="invoice__editable">        №        <span name="sku" model-attr="sku">            ',_.escape(block.invoiceModel.get("sku")),'        </span>    </span>    от    <span name="acceptanceDate" class="invoice__editable" model-attr="acceptanceDate">        ',moment(block.invoiceModel.get("acceptanceDate")).format("DD.MM.YYYY HH:mm"),'    </span></div><div class="invoice__head invoice__dataRow">    <div>        <div class="invoice__headItem">        <span class="invoice__headItemData invoice__editable" name="supplier" model-attr="supplier">            ',block.invoiceModel.get("supplier"),'        </span>            <div class="invoice__headItemHint">                поставщик            </div>        </div>        <div class="invoice__headItem">        <span class="invoice__headItemData invoice__editable" name="accepter" model-attr="accepter">            ',block.invoiceModel.get("accepter"),'        </span>            <div class="invoice__headItemHint">                приёмщик            </div>        </div>        <div class="invoice__headItem">        <span class="invoice__headItemData invoice__editable" name="legalEntity" model-attr="legalEntity">            ',block.invoiceModel.get("legalEntity"),'        </span>            <div class="invoice__headItemHint">                получатель            </div>        </div>    </div></div><div class="invoice__dataRow invoice__supplier    ',!block.invoiceModel.get("supplierInvoiceSku")&&!block.invoiceModel.get("supplierInvoiceDate")?"invoice__hiddenData":"",'">    Входящая накладная    <span class="invoice__editable        ',block.invoiceModel.get("supplierInvoiceSku")?"":"invoice__hiddenData",'    ">        №        <span name="supplierInvoiceSku" model-attr="supplierInvoiceSku">',block.invoiceModel.get("supplierInvoiceSku")?block.invoiceModel.get("supplierInvoiceSku"):"Ввести номер",'</span>    </span>    <span class="        ',block.invoiceModel.get("supplierInvoiceDate")?"":"invoice__hiddenData",'    ">        от <span name="supplierInvoiceDate" class="invoice__editable" model-attr="supplierInvoiceDate">            ',block.invoiceModel.get("supplierInvoiceDate")?moment(block.invoiceModel.get("supplierInvoiceDate")).format("DD.MM.YYYY"):"Ввести дату","        </span>    </span></div>");return __p.join("")}}),define("tpl!blocks/invoice/templates/removeConfirm.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<tr class="invoice__removeConfirmRow" invoice-product-id="',invoiceProductId,'">    <td colspan="6">        <a class="button invoice__removeConfirmButton">Подтвердить</a>        <a class="invoice__removeCancel">отменить удаление</a>    </td></tr>');return __p.join("")}}),define("tpl!blocks/invoice/templates/row.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<tr invoice-product-id="',invoiceProduct.id,'" name="invoiceProduct" class="invoice__dataRow" product-sku="',invoiceProduct.product.sku,'">    <td>        <span name="productName"              class="invoice__editable"              autocomplete-name="name"              model-attr="product"              product-id="',invoiceProduct.product.id,'">',invoiceProduct.product.name,'</span>        <br />        <span name="productSku"              class="invoice__editable"              autocomplete-name="sku"              model-attr="product"              product-id="',invoiceProduct.product.id,'">',invoiceProduct.product.sku,'</span>    </td>    <td>        <span name="productBarcode"              class="invoice__editable ',invoiceProduct.product.barcode?"":"invoice__hiddenData",'"              autocomplete-name="barcode"              model-attr="product"              product-id="',invoiceProduct.product.id,'">            ',invoiceProduct.product.barcode?invoiceProduct.product.barcode:"Ввести штрихкод",'        </span>    </td>    <td>        <span class="invoice__editable">            <span name="productAmount" model-attr="quantity">                ',invoiceProduct.quantity,'            </span>            <span name="productUnits">                ',LH.helpers.units(invoiceProduct.product.units,"smallShort"),'            </span>        </span>    </td>    <td>        <span class="invoice__editable">            <span>                по            </span>            <span name="productPrice" model-attr="price">                ',LH.helpers.formatPrice(invoiceProduct.price),'            </span>            <span>                р.            </span>        </span>    </td>    <td>        <span>            =        </span>        <span name="productSum">            ',LH.helpers.formatPrice(invoiceProduct.totalPrice),'        </span>        <span>            р.        </span>    </td>    <td style="width: 1px;">        <span class="invoice__removeLink">удалить</span>    </td></tr>');return __p.join("")}}),define("tpl!blocks/invoice/templates/table.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push("<tbody>    "),_.each(block.invoiceProductCollection.toJSON(),function(e){__p.push("        ",block.templates.row({invoiceProduct:e,block:block}),"    ")}),__p.push("</tbody>");return __p.join("")}}),define("blocks/invoice/invoice",["require","kit/block","kit/inputDate/inputDate","models/invoice","collections/invoiceProducts","blocks/invoice/addProductForm","tpl!./templates/invoice.html","tpl!./templates/dataInput.html","tpl!./templates/dataInputAutocomplete.html","tpl!./templates/dataInputControls.html","tpl!./templates/footer.html","tpl!./templates/head.html","tpl!./templates/removeConfirm.html","tpl!./templates/row.html","tpl!./templates/table.html"],function(e){var t=e("kit/block"),n=e("kit/inputDate/inputDate"),r=e("models/invoice"),i=e("collections/invoiceProducts"),s=e("blocks/invoice/addProductForm");return t.extend({editMode:!1,dataEditing:!1,className:"invoice",templates:{index:e("tpl!./templates/invoice.html"),dataInput:e("tpl!./templates/dataInput.html"),dataInputAutocomplete:e("tpl!./templates/dataInputAutocomplete.html"),dataInputControls:e("tpl!./templates/dataInputControls.html"),footer:e("tpl!./templates/footer.html"),head:e("tpl!./templates/head.html"),removeConfirm:e("tpl!./templates/removeConfirm.html"),row:e("tpl!./templates/row.html"),table:e("tpl!./templates/table.html")},initialize:function(){var e=this;e.invoiceProductCollection=new i({invoiceId:e.invoiceId}),e.invoiceModel=new r({id:e.invoiceId}),e.invoiceModel.fetch(),e.invoiceProductCollection.fetch(),e.render(),e.set("editMode",e.editMode),e.addForm=new s({invoiceId:e.invoiceId,el:e.el.getElementsByClassName("invoice__addProductForm")}),e.listenTo(e.addForm,{successSubmit:function(t){e.invoiceProductCollection.push(t),e.addForm.clear()}}),e.listenTo(e.invoiceModel,"sync change",function(){e.$head.html(e.templates.head({block:e})),e.$footer.html(e.templates.footer({block:e}))}),e.listenTo(e.invoiceProductCollection,{sync:function(){e.renderTable()},add:function(t){e.renderTable(),e.invoiceModel.set(t.toJSON().invoice)},change:function(t){e.invoiceModel.set(t.toJSON().invoice)},destroy:function(){e.renderTable(),e.invoiceModel.fetch()}})},events:{"click .invoice__removeLink":function(e){e.preventDefault();var t=this,n=$(e.target).closest(".invoice__dataRow").attr("invoice-product-id");t.showRemoveConfirm(n)},"click .invoice__removeCancel":function(e){e.preventDefault();var t=this,n=$(e.target).closest(".invoice__removeConfirmRow").attr("invoice-product-id");t.hideRemoveConfirm(n)},"click .invoice__removeConfirmButton":function(e){e.preventDefault();var t=this,n=$(e.target).closest(".invoice__removeConfirmRow").attr("invoice-product-id");t.removeInvoiceProduct(n),t.set("dataEditing",!1)},"click .invoice__editLink":function(e){e.preventDefault();var t=this;t.set("editMode",!0)},"click .invoice__stopEditLink, .invoice__stopEditButton":function(e){e.preventDefault();var t=this,n=!1;t.addForm.$el.find("input").each(function(){$(this).val()&&(n=!0)}),n||t.dataEditing?alert("У вас есть несохранённые данные"):t.set("editMode",!1)},"click .invoice__editable":function(e){e.preventDefault(),e.stopPropagation();var t=this;t.editMode&&!t.dataEditing&&t.showDataInput($(e.currentTarget))},"submit .invoice__table .invoice__dataInput":function(e){e.preventDefault();var t=this,n=Backbone.Syphon.serialize(e.target),r=$(e.target).closest("[invoice-product-id]").attr("invoice-product-id"),i=t.invoiceProductCollection.get(r),s=$(e.target).find('[type="submit"]').closest(".button");t.removeInlineErrors(),s.addClass("preloader"),i.save(n,{success:function(){t.set("dataEditing",!1),s.removeClass("preloader")},error:function(e,n){t.showInlineErrors(JSON.parse(n.responseText)),s.removeClass("preloader")}})},"submit .invoice__head .invoice__dataInput":function(e){e.preventDefault();var t=this,n=Backbone.Syphon.serialize(e.target),r=$(e.target).find('[type="submit"]').closest(".button");t.removeInlineErrors(),r.addClass("preloader"),t.invoiceModel.save(n,{success:function(){t.set("dataEditing",!1),r.removeClass("preloader")},error:function(e,n){t.showInlineErrors(JSON.parse(n.responseText)),r.removeClass("preloader")},wait:!0})},"click .invoice__dataInputSave":function(e){e.preventDefault();var t=this,n=t.$el.find(".invoice__dataInput");n.submit()},"click .invoice__dataInputCancel":function(e){var t=this;e.preventDefault(),t.removeDataInput()}},"set:editMode":function(e){var t=this;e?t.$el.addClass("invoice_editMode"):t.$el.removeClass("invoice_editMode")},"set:dataEditing":function(e){var t=this;t.addForm.disable(e),e?t.$el.addClass("invoice_dataEditing"):t.$el.removeClass("invoice_dataEditing")},showRemoveConfirm:function(e){var t=this,n=t.$table.find('.invoice__dataRow[invoice-product-id="'+e+'"]');t.hideRemoveConfirms(),t.set("dataEditing",!0),n.after(t.templates.removeConfirm({invoiceProductId:e})).hide()},hideRemoveConfirm:function(e){var t=this,n=t.$table.find('.invoice__dataRow[invoice-product-id="'+e+'"]'),r=t.$table.find('.invoice__removeConfirmRow[invoice-product-id="'+e+'"]');r.remove(),n.show(),t.set("dataEditing",!1)},hideRemoveConfirms:function(){var e=this,t=e.$table.find(".invoice__dataRow:hidden"),n=e.$table.find(".invoice__removeConfirmRow");t.show(),n.remove()},removeInvoiceProduct:function(e){var t=this,n=t.invoiceProductCollection.get(e);n.destroy({wait:!0})},renderTable:function(){var e=this;e.$table.html(e.templates.table({block:e}))},showInlineErrors:function(e){var t=this,n=t.$el.find(".invoice__dataInput .inputText"),r=t.$el.find(".invoice__dataInputControls");n.addClass("inputText_error"),_.each(e.children,function(e){var t;e.errors&&(t=e.errors.join(", "),r.attr("lh_field_error",t))})},removeInlineErrors:function(){var e=this,t=e.$el.find(".invoice__dataInput .inputText"),n=e.$el.find(".invoice__dataInputControls");t.removeClass(".inputText_error"),n.removeAttr("lh_field_error")},showDataInput:function(e){var t=this,r=e,i=e.closest(".invoice__dataRow"),s=t.templates.dataInputControls();t.set("dataEditing",!0),r.attr("model-attr")||(r=e.find("[model-attr]")),i.prop("tagName")==="TR"&&(s='<tr class="invoice__dataInputControlsTr"><td class="invoice__dataInputControlsTd" colspan="'+i.find("td").length+'">'+s+"</td></tr>");switch(r.attr("model-attr")){case"product":r.append(t.templates.dataInputAutocomplete({$dataElement:r})),this.autocompleteToInput(r.find("[lh_product_autocomplete]"));break;case"acceptanceDate":r.append(t.templates.dataInput({$dataElement:r})),new n({el:r.find(".inputText")[0]});break;case"supplierInvoiceDate":r.append(t.templates.dataInput({$dataElement:r})),new n({el:r.find(".inputText")[0],noTime:!0});break;default:r.append(t.templates.dataInput({$dataElement:r}))}i.after(s),r.find(".inputText").css({width:r.width(),font:r.css("font")}).focus()},removeDataInput:function(){var e=this;e.$el.find(".invoice__dataInput").remove(),e.$el.find(".invoice__dataInputControls").remove(),e.$el.find(".invoice__dataInputControlsTr").remove(),e.set("dataEditing",!1)},autocompleteToInput:function(e){var t=e.attr("lh_product_autocomplete");e.autocomplete({source:function(e,n){$.ajax({url:baseApiUrl+"/products/"+t+"/search.json",dataType:"json",data:{query:e.term},success:function(e){n($.map(e,function(e){return{label:e[t],product:e}}))}})},minLength:3,select:function(e,t){$(this).parents("form").find("[lh_product_autocomplete='name']").val(t.item.product.name),$(this).parents("form").find("[lh_product_autocomplete='sku']").val(t.item.product.sku),$(this).parents("form").find("[lh_product_autocomplete='barcode']").val(t.item.product.barcode),$(this).parents("form").find("[name='product']").val(t.item.product.id),$(this).parents("form").find("[name='quantity']").focus()}}),e.keyup(function(e){var n=$.ui.keyCode;switch(e.keyCode){case n.PAGE_UP:case n.PAGE_DOWN:case n.UP:case n.DOWN:case n.ENTER:case n.NUMPAD_ENTER:case n.TAB:case n.LEFT:case n.RIGHT:case n.ESCAPE:return;default:var r=$(this).autocomplete("getTerm");if(r!=$(this).val()){var i=["name","sku","barcode"];for(var s in i)i[s]!=t&&$(this).parents("form").find("[lh_product_autocomplete='"+i[s]+"']").val("").trigger("input");$(this).parents("form").find("[name='product']").val("")}}})}})}),define("routers/invoice",["require","blocks/content/content_main","routers/baseRouter"],function(e){var t=e("blocks/content/content_main"),n=e("routers/baseRouter"),r=n.extend({routes:{invoices:"list","invoice/list":"list","invoice/create":"create","invoice/:invoiceId":"view"},view:function(e,n){t.load("/pages/invoice/view.html",{invoiceId:e,params:n||{}})},create:function(){t.load("/pages/invoice/create.html")},list:function(){t.load("/pages/invoice/list.html")}});return new r}),define("routers/balance",["require","blocks/content/content_main","routers/baseRouter"],function(e){var t=e("blocks/content/content_main"),n=e("routers/baseRouter"),r=n.extend({routes:{balance:"balance"},balance:function(){t.load("/pages/balance.html")}});return new r}),define("routers/product",["require","blocks/content/content_main","routers/baseRouter"],function(e){var t=e("blocks/content/content_main"),n=e("routers/baseRouter"),r=n.extend({routes:{products:"productList","product/list":"productList","product/edit/:productId":"productEdit","product/create":"productCreate","product/view/:productId":"productView","product/:productId":"productView"},productList:function(){t.load("/pages/product/list.html")},productView:function(e){t.load("/pages/product/view.html",{productId:e})},productCreate:function(){t.load("/pages/product/create.html")},productEdit:function(e){t.load("/pages/product/edit.html",{productId:e})}});return new r}),define("routers/writeOff",["require","blocks/content/content_main","routers/baseRouter"],function(e){var t=e("blocks/content/content_main"),n=e("routers/baseRouter"),r=n.extend({routes:{writeOffs:"list","writeOff/create":"create","writeOff/:writeOffId":"view"},view:function(e,n){t.load("/pages/writeOff/view.html",{writeOffId:e,params:n||{}})},list:function(){t.load("/pages/writeOff/list.html")},create:function(){t.load("/pages/writeOff/create.html")}});return new r}),define("routers/mainRouter",["require","blocks/content/content_main","routers/baseRouter","routers/invoice","routers/balance","routers/product","routers/writeOff","routers/catalog"],function(e){var t=e("blocks/content/content_main"),n=e("routers/baseRouter");e("routers/invoice"),e("routers/balance"),e("routers/product"),e("routers/writeOff"),e("routers/catalog");var r=n.extend({routes:{"":"dashboard","/":"dashboard",dashboard:"dashboard",sale:"sale"},dashboard:function(){t.load("/pages/dashboard.html")},sale:function(){t.load("/pages/sale.html")}});return new r}),define("tpl!blocks/invoiceForm/templates/invoiceForm.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<fieldset class="form__fieldset">    <div class="form__field form__field_inline">        <label class="form__label">Приемка №</label>        <input class="inputText"               type="text"               name="sku"/>        <span style="vertical-align: middle; margin: 0 5px 0 10px;">от</span>        <input style="width: 200px;"               value="',moment().format("DD.MM.YYYY HH:mm"),'"               class="inputText inputDate"               type="text"               name="acceptanceDate"               require="kit/inputDate/inputDate"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Поставщик</label>        <input class="inputText"               type="text"               name="supplier"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Кто принял</label>        <input class="inputText" name="accepter"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Получатель</label>        <input class="inputText" name="legalEntity"/>    </div></fieldset><fieldset class="form__fieldset">    <legend class="form__legend">Необязательно к заполнению</legend>    <div class="form__field form__field_inline">        <label class="form__label">Входящий номер</label>        <input class="inputText"               type="text"               name="supplierInvoiceSku"/>        <span style="vertical-align: middle; margin: 0 5px 0 10px;">от</span>        <input style="width: 200px;"               class="inputText"               type="text"               name="supplierInvoiceDate"               require="kit/inputDate/inputDate_noTime"/>    </div></fieldset><div class="form__controls">    <span class="button button_color_blue">        ',"Сохранить и перейти к добавлению товаров",'        <input type="submit"/>    </span></div>');return __p.join("")}}),define("blocks/invoiceForm/invoiceForm",["require","kit/form/form","moment","models/invoice","routers/mainRouter","tpl!./templates/invoiceForm.html"],function(e){var t=e("kit/form/form"),n=e("moment"),r=e("models/invoice"),i=e("routers/mainRouter");return t.extend({invoiceId:null,className:"invoiceForm",templates:{index:e("tpl!./templates/invoiceForm.html")},initialize:function(){var e=this;e.invoiceModel=new r({id:e.invoiceId}),e.listenTo(e.invoiceModel,{sync:function(){e.render()}}),e.render()},submit:function(){var e=this,t=$.Deferred(),n=Backbone.Syphon.serialize(e);return e.invoiceModel.save(n,{success:function(e){i.navigate("/invoice/"+e.id+"?editMode=true",{trigger:!0})},error:function(e,n){t.reject(JSON.parse(n.responseText))}}),t.promise()}})}),define("collections/invoices",["require","collections/baseCollection","models/invoice"],function(e){var t=e("collections/baseCollection"),n=e("models/invoice");return t.extend({model:n,url:baseApiUrl+"/invoices"})}),define("tpl!blocks/invoiceList/templates/invoiceList.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<table class="table invoiceList__table">    ',block.templates.table({block:block}),"</table>");return __p.join("")}}),define("tpl!blocks/invoiceList/templates/table.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push("<thead><tr>    <th>Дата</th>    <th>Номер</th>    <th>Поставщик</th>    <th>Сумма</th>    <th>Принял</th></tr></thead><tbody>"),_.each(block.invoiceCollection.toJSON(),function(e){__p.push("    ",block.templates.row({block:block,invoice:e}),"")}),__p.push("</tbody>");return __p.join("")}}),define("tpl!blocks/invoiceList/templates/row.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<tr name="invoice" href="/invoice/',invoice.id,'">    <td>        <span name="acceptanceDate">',moment(invoice.acceptanceDate).format("DD.MM.YYYY HH:mm"),'</span>    </td>    <td>        <span name="sku">',invoice.sku,'</span>    </td>    <td>        <span name="supplier">',invoice.supplier,'</span>    </td>    <td>        <span name="sumTotal">',LH.helpers.formatPrice(invoice.sumTotal),'</span>        <span>р.</span>    </td>    <td>        <span name="accepter">',invoice.accepter,"</span>    </td></tr>");return __p.join("")}}),define("blocks/invoiceList/invoiceList",["require","kit/block","collections/invoices","moment","tpl!./templates/invoiceList.html","tpl!./templates/table.html","tpl!./templates/row.html"],function(e){var t=e("kit/block"),n=e("collections/invoices"),r=e("moment");return t.extend({invoiceCollection:new n,className:"invoiceList",templates:{index:e("tpl!./templates/invoiceList.html"),table:e("tpl!./templates/table.html"),row:e("tpl!./templates/row.html")},initialize:function(){var e=this;e.render(),e.listenTo(e.invoiceCollection,{reset:function(){e.renderTable()},request:function(){e.$table.find("thead").addClass("preloader_rows")}}),e.invoiceCollection.fetch()},renderTable:function(){var e=this;e.$table.html(e.templates.table({block:e})).find("thead").removeClass("preloader_rows")}})}),define("tpl!blocks/product/templates/product.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="page__controls">    <a class="page__controlsList product_editLink"       lh_link="edit"       href="/product/edit/',block.productModel.get("id"),'">        Редактировать    </a></div><div class="product__content">    <div class="product__head">        <div class="product__name">            <span name="name">',block.productModel.get("name"),'</span>        </div>        <div class="product__sku">            <span name="sku">',block.productModel.get("sku"),'</span>        </div>    </div>    <div class="product__body">        <table class="product__propertiesTable">            <tr>                <th>Закупочная цена</th>                <td>                    <span name="purchasePrice">                        ',LH.helpers.formatPrice(block.productModel.get("purchasePrice")),'                    </span>                    руб.                </td>            </tr>            <tr>                <th>НДС</th>                <td>                    <span name="vat">',block.productModel.get("vat"),'</span>                    %                </td>            </tr>            <tr>                <th>Штрих-код</th>                <td>                    <span name="barcode">',block.productModel.get("barcode"),'</span>                </td>            </tr>            <tr>                <th>Единица измерения</th>                <td>                    <span name="units">',LH.helpers.units(block.productModel.get("units"),"smallFull"),'</span>                </td>            </tr>            <tr>                <th>Производитель</th>                <td>                    <span name="vendor">',block.productModel.get("vendor"),'</span>                </td>            </tr>            <tr>                <th>Страна</th>                <td>                    <span name="vendorCountry">',block.productModel.get("vendorCountry"),"</span>                </td>            </tr>            <tr>                <th>Наценка</th>                <td>                    "),block.productModel.get("retailMarkup")?__p.push('                        <span name="retailMarkup">                            ',block.productModel.get("retailMarkup"),"                        </span>                        %                    "):__p.push('                        <span name="retailMarkup">                            <i>отсутствует</i>                        </span>                    '),__p.push("                </td>            </tr>            <tr>                <th>Цена продажи</th>                <td>                    "),block.productModel.get("retailPrice")?__p.push('                        <span name="retailPrice">                            ',LH.helpers.formatPrice(block.productModel.get("retailPrice")),"                        </span>                        руб.                    "):__p.push('                        <span name="retailPrice">                            <i>отсутствует</i>                        </span>                    '),__p.push('                </td>            </tr>        </table>        <p name="info">            ',block.productModel.get("info"),"        </p>    </div></div>");return __p.join("")}}),define("blocks/product/product",["require","kit/block","models/product","tpl!./templates/product.html"],function(e){var t=e("kit/block"),n=e("models/product");return t.extend({productId:null,className:"product",templates:{index:e("tpl!./templates/product.html")},initialize:function(){var e=this;e.productModel=new n({id:e.productId}),e.listenTo(e.productModel,{sync:function(){e.render()}}),e.productModel.fetch()}})}),define("helpers/formatPrice",[],function(){return function(e){return null==e?e="0,00":e=e.toString().replace(".",","),-1==e.indexOf(",")&&(e+=","),e+="00",e=e.replace(/(,\d{2})\d*$/,"$1"),e}}),define("helpers/isEmptyJSON",[],function(){return function(e){for(var t in e)if(""!=e[t])return!1;return!0}}),define("helpers/normalizePrice",[],function(){return function(e){return e=+e.split(",").join("."),+e.toFixed(2)}}),define("helpers/prevalidateInput",[],function(){function n(t){var n=_.find(e,function(e,n){return t==e})}var e={BACKSPACE:8,",":188,".":190,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},t={price:/\d+[\.,]?\d{0,2}/};return function(t){var n=$(t.target),r=!0,i,s=$(t.target).data("prevalidate");i=new RegExp(s,"ig"),console.log(t.keyCode);if(_.indexOf(_.values(e),t.keyCode))return!0;if(t.ctrlKey||t.shiftKey)return!0}}),define("helpers/units",[],function(){var e={kg:{capitalFull:"Килограммы",smallFull:"килограмм",smallShort:"кг"},unit:{capitalFull:"Штуки",smallFull:"штука",smallShort:"шт."},liter:{capitalFull:"Литры",smallFull:"литр",smallShort:"л"}};return function(t,n){return e[t][n]}}),define("helpers/helpers",["require","helpers/formatPrice","helpers/isEmptyJSON","helpers/normalizePrice","helpers/prevalidateInput","helpers/units"],function(e){return{formatPrice:e("helpers/formatPrice"),isEmptyJSON:e("helpers/isEmptyJSON"),normalizePrice:e("helpers/normalizePrice"),prevalidateInput:e("helpers/prevalidateInput"),units:e("helpers/units")}}),define("tpl!blocks/productForm/templates/productForm.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<h3>Добавление нового товара в матрицу</h3><fieldset class="form__fieldset">    <div class="form__field form__field_inline">        <label class="form__label">Артикул</label>        <input value="',_.escape(block.productModel.get("sku")),'" class="inputText" type="text" name="sku"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Наименование</label>        <input value="',_.escape(block.productModel.get("name")),'" class="inputText" type="text" name="name"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Измеряется в</label>        <select value="',_.escape(block.productModel.get("units")),'" class="select" name="units" require="/blocks/select/select_units.js"></select>    </div>    <div class="form__field form__field_inline">        <label class="form__label">НДС</label>        <select value="',_.escape(block.productModel.get("vat")),'" class="select" name="vat" require="/blocks/select/select_vat.js"></select>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Цена закупки</label>        <input style="width: 150px;" value="',block.productModel.get("purchasePrice")?_.escape(LH.helpers.formatPrice(block.productModel.get("purchasePrice"))):"",'" class="inputText" type="text" name="purchasePrice"/>        <span class="inputText__postfix">руб.</span>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Наценка</label>        <input style="width: 150px;" value="',_.escape(block.productModel.get("retailMarkup")),'" class="inputText productForm__linkedInput ',block.productModel.get("retailPricePreference")=="retailMarkup"?"":"productForm__hiddenInput",'" type="text" name="retailMarkup"/>        <span class="productForm__inputLink">            <span class="productForm__inputLinkText" name="retailMarkupHint"></span>        </span>        <span class="inputText__postfix">%</span>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Цена продажи</label>        <input style="width: 150px;" value="',block.productModel.get("retailPrice")?_.escape(LH.helpers.formatPrice(block.productModel.get("retailPrice"))):"",'" class="inputText productForm__linkedInput ',block.productModel.get("retailPricePreference")=="retailMarkup"?"productForm__hiddenInput":"",'" type="text" name="retailPrice"/>        <span class="productForm__inputLink">            <span class="productForm__inputLinkText" name="retailPriceHint"></span>        </span>        <span class="inputText__postfix">руб.</span>    </div>    <input type="hidden" value="',block.productModel.get("retailPricePreference"),'" name="retailPricePreference" /></fieldset><fieldset class="form__fieldset">    <legend class="form__legend">Необязательно к заполнению</legend>    <div class="form__field form__field_inline">        <label class="form__label">Штрихкод</label>        <input value="',_.escape(block.productModel.get("barcode")),'" class="inputText" type="text" name="barcode"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Страна производства</label>        <input value="',_.escape(block.productModel.get("vendorCountry")),'" class="inputText" type="text" name="vendorCountry"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Производитель</label>        <input value="',_.escape(block.productModel.get("vendor")),'" class="inputText" type="text" name="vendor"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Дополнительная информация</label>        <textarea class="inputText" name="info">',_.escape(block.productModel.get("info")),'</textarea>    </div></fieldset><div class="form__controls">    <span class="button button_color_blue">        ',block.productId?"Сохранить товар":"Добавить товар",'        <input type="submit"/>    </span></div>');return __p.join("")}}),define("blocks/productForm/productForm",["require","kit/form/form","models/product","helpers/helpers","routers/mainRouter","tpl!./templates/productForm.html"],function(e){var t=e("kit/form/form"),n=e("models/product"),r=e("helpers/helpers"),i=e("routers/mainRouter");return t.extend({defaultInputLinkText:"Введите значение",productId:null,className:"productForm",templates:{index:e("tpl!./templates/productForm.html")},initialize:function(){var e=this;e.productModel=new n({id:e.productId}),e.productId?e.productModel.fetch():e.render(),e.listenTo(e.productModel,{sync:function(){e.render()}})},events:{"click .productForm__inputLink":function(e){e.preventDefault;var t=$(e.currentTarget),n=t.prev(".productForm__linkedInput");switch(n.attr("name")){case"retailMarkup":this.showRetailMarkupInput();break;case"retailPrice":this.showRetailPriceInput()}},'keyup [name="purchasePrice"]':function(e){this.$retailPriceInput.is(":hidden")&&this.calculateRetailPrice(),this.$retailMarkupInput.is(":hidden")&&this.calculateRetailMarkup()},'keyup [name="retailMarkup"]':function(){this.calculateRetailPrice()},'keyup [name="retailPrice"]':function(){this.calculateRetailMarkup()},'change [name="retailMarkup"]':function(){this.renderRetailMarkupLink()},'change [name="retailPrice"]':function(){this.renderRetailPriceLink()}},findElements:function(){var e=this;t.prototype.findElements.apply(e,arguments),e.$retailPricePreferenceInput=e.$el.find('[name="retailPricePreference"]'),e.$retailPriceInput=e.$el.find('[name="retailPrice"]'),e.$retailMarkupInput=e.$el.find('[name="retailMarkup"]'),e.$purchasePriceInput=e.$el.find('[name="purchasePrice"]'),e.$retailPriceLink=e.$retailPriceInput.next(".productForm__inputLink"),e.$retailMarkupLink=e.$retailMarkupInput.next(".productForm__inputLink")},_afterRender:function(){var e=this;e.renderRetailMarkupLink(),e.renderRetailPriceLink()},submit:function(){var e=this,t=$.Deferred(),n=Backbone.Syphon.serialize(e);return e.productModel.save(n,{success:function(){i.navigate(e.productId?"/product/"+e.productId:"/products",{trigger:!0})},error:function(e,n){t.reject(JSON.parse(n.responseText))}}),t.promise()},showRetailMarkupInput:function(){this.$retailPriceInput.addClass("productForm__hiddenInput"),this.$retailMarkupInput.removeClass("productForm__hiddenInput").focus(),this.$retailPricePreferenceInput.val("retailMarkup")},showRetailPriceInput:function(){this.$retailMarkupInput.addClass("productForm__hiddenInput"),this.$retailPriceInput.removeClass("productForm__hiddenInput").focus(),this.$retailPricePreferenceInput.val("retailPrice")},calculateRetailPrice:function(){var e=r.normalizePrice(this.$purchasePriceInput.val()),t=r.normalizePrice(this.$retailMarkupInput.val()),n;!e||!t||_.isNaN(e)||_.isNaN(t)?n="":n=r.formatPrice(+(t/100*e).toFixed(2)+e),this.$retailPriceInput.val(n).change()},calculateRetailMarkup:function(){var e=r.normalizePrice(this.$retailPriceInput.val()),t=r.normalizePrice(this.$purchasePriceInput.val()),n;!t||!e||_.isNaN(t)||_.isNaN(e)?n="":n=r.formatPrice(+(e*100/t).toFixed(2)-100),this.$retailMarkupInput.val(n).change()},renderRetailPriceLink:function(){var e=$.trim(this.$retailPriceInput.val()),t;e?t=r.formatPrice(e)+" руб.":t=this.defaultInputLinkText,this.$retailPriceLink.find(".productForm__inputLinkText").html(t)},renderRetailMarkupLink:function(){var e=$.trim(this.$retailMarkupInput.val()),t;e?t=r.formatPrice(e)+"%":t=this.defaultInputLinkText,this.$retailMarkupLink.find(".productForm__inputLinkText").html(t)}})}),define("tpl!blocks/productList/templates/productList.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<table class="table productList__table">    ',block.templates.table({block:block}),"</table>");return __p.join("")}}),define("tpl!blocks/productList/templates/table.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push("<thead><tr>    <th>Артикул</th>    <th>Название</th>    <th>Производитель</th>    <th>Страна</th>    <th>Цена</th></tr></thead><tbody>"),_.each(block.productCollection.toJSON(),function(e){__p.push("    ",block.templates.row({block:block,product:e}),"")}),__p.push("</tbody>");return __p.join("")}}),define("tpl!blocks/productList/templates/row.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<tr name="product" href="/product/',product.id,'">    <td>        <span name="sku">',product.sku,'</span>    </td>    <td>        <span name="name">',product.name,'</span>    </td>    <td>        <span name="vendor">',product.vendor,'</span>    </td>    <td>        <span name="vendorCountry">',product.vendorCountry,'</span>    </td>    <td>        <span name="purchasePrice">',LH.helpers.formatPrice(product.purchasePrice)," р.</span>    </td></tr>");return __p.join("")}}),define("blocks/productList/productList",["require","kit/block","collections/products","tpl!./templates/productList.html","tpl!./templates/table.html","tpl!./templates/row.html"],function(e){var t=e("kit/block"),n=e("collections/products");return t.extend({className:"productList",productCollection:new n,templates:{index:e("tpl!./templates/productList.html"),table:e("tpl!./templates/table.html"),row:e("tpl!./templates/row.html")},initialize:function(){var e=this;e.listenTo(e.productCollection,{reset:function(){e.renderTable()},request:function(){e.$table.find("thead").addClass("preloader_rows")}}),e.render(),e.productCollection.fetch()},renderTable:function(){var e=this;e.$table.html(e.templates.table({block:e})).find("thead").removeClass("preloader_rows")}})}),define("models/purchase",["require","models/baseModel"],function(e){var t=e("models/baseModel");return t.extend({modelName:"purchase",urlRoot:baseApiUrl+"/purchases",defaults:{products:[]},saveFields:["products"]})}),define("tpl!blocks/saleBox/templates/saleBox.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<h2>Эмулятор продажи</h2><form class="form saleBox__purchaseForm" id="saleBox__purchaseForm">    <table class="table saleBox__purchaseTable">        <thead>        <tr>            <th style="width: 500px;">Наздвание товара</th>            <th style="width: 100px;">Количество</th>            <th style="width: 150px;">Цена</th>            <th></th>        </tr>        </thead>        <tbody>        </tbody>    </table></form><form class="form saleBox__productForm">    <table class="table">        <tr class="saleBox__productRow">            <td style="width: 500px;">                <input lh_product_autocomplete="name" type="text" class="inputText" placeholder="Наздвание товара"/>                <input type="hidden" name="product[]" />            </td>            <td style="width: 100px;">                <input name="quantity[]" type="text" class="inputText" placeholder="Количество"/>            </td>            <td style="width: 150px;">                <input name="sellingPrice[]" type="text" class="inputText" placeholder="Цена"/>            </td>            <td class="saleBox__rowControls">                <span class="button saleBox__addProductLink">                    Добавить                    <input type="submit"/>                </span>                <span class="button saleBox__removeProductLink">                    Удалить                </span>            </td>        </tr>    </table></form><div>    <span class="button button_color_blue">        Расчитать        <input type="submit" form="saleBox__purchaseForm"/>    </span></div>');return __p.join("")}}),define("blocks/saleBox/saleBox",["require","kit/block","kit/form/form","models/purchase","tpl!./templates/saleBox.html"],function(e){var t=e("kit/block"),n=e("kit/form/form"),r=e("models/purchase");return t.extend({purchaseModel:new r,className:"saleBox",templates:{index:e("tpl!./templates/saleBox.html")},events:{"click .saleBox__removeProductLink":function(e){var t=this,n=$(e.target);n.closest(".saleBox__productRow").remove()},"submit .saleBox__productForm":function(e){e.preventDefault();var t=this;t.$productRow.clone().appendTo(t.$purchaseTable.find("tbody")),t.$productForm.find("input").val("")}},autocompleteToInput:function(e){var t=e.attr("lh_product_autocomplete");e.autocomplete({source:function(e,n){$.ajax({url:baseApiUrl+"/products/"+t+"/search.json",dataType:"json",data:{query:e.term},success:function(e){n($.map(e,function(e){return{label:e[t],product:e}}))}})},minLength:3,select:function(e,t){$(this).parents("form").find("[lh_product_autocomplete='name']").val(t.item.product.name),$(this).parents("form").find("[name='product[]']").val(t.item.product.id),$(this).parents("form").find("[name='quantity[]']").focus()}}),e.keyup(function(e){var t=$.ui.keyCode;switch(e.keyCode){case t.PAGE_UP:case t.PAGE_DOWN:case t.UP:case t.DOWN:case t.ENTER:case t.NUMPAD_ENTER:case t.TAB:case t.LEFT:case t.RIGHT:case t.ESCAPE:return;default:var n=$(this).autocomplete("getTerm");n!=$(this).val()&&$(this).parents("form").find("[name='product']").val("")}})},_afterRender:function(){var e=this;e.purchaseForm=new n({el:e.$purchaseForm[0],submit:function(){var t=$.Deferred(),n=Backbone.Syphon.serialize(this),r=[];return _.each(n.product,function(e,t){r.push({product:e,quantity:n.quantity[t],sellingPrice:n.sellingPrice[t]})}),e.purchaseModel.save({products:r},{success:function(){alert("Продано!"),document.location.reload(),t.resolve()},error:function(){alert("Ошибка!"),t.reject()}}),t.promise()}}),e.purchaseForm.$submitButton=e.$el.find('[form="saleBox__purchaseForm"]').closest(".button"),e.autocompleteToInput(e.$productForm.find("[lh_product_autocomplete]"))}})}),define("kit/select/select",["require","kit/block"],function(e){var t=e("kit/block");return t.extend({initialize:function(){this.render(),this.$el.val(this.$el.attr("value"))}})}),define("tpl!blocks/select/templates/select_units.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<option value="">    единица измерения</option><option value="kg">    Килограммы</option><option value="unit">    Штуки</option><option value="liter">    Литры</option>');return __p.join("")}}),define("blocks/select/select_units",["require","kit/select/select","tpl!./templates/select_units.html"],function(e){var t=e("kit/select/select");return t.extend({templates:{index:e("tpl!./templates/select_units.html")}})}),define("tpl!blocks/select/templates/select_vat.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<option value="">    выберите ставку</option><option value="0">    Не облагается</option><option value="10">    10%</option><option value="18">    18%</option>');return __p.join("")}}),define("blocks/select/select_vat",["require","kit/select/select","tpl!./templates/select_vat.html"],function(e){var t=e("kit/select/select");return t.extend({templates:{index:e("tpl!./templates/select_vat.html")}})}),define("models/writeOff",["require","models/baseModel"],function(e){var t=e("models/baseModel");return t.extend({modelName:"writeOff",urlRoot:baseApiUrl+"/writeoffs",dateFormat:"dd.mm.yy",datePrintFormat:"dd.mm.yyyy",timeFormat:"HH:mm",invalidMessage:"Вы ввели неверную дату",saveFields:["number","date"]})}),define("models/writeOffProduct",["require","models/baseModel"],function(e){var t=e("models/baseModel");return t.extend({modelName:"writeOffProduct",urlRoot:function(){return baseApiUrl+"/writeoffs/"+this.get("writeOff").id+"/products"},saveFields:["product","quantity","price","cause"]})}),define("collections/writeOffProducts",["require","collections/baseCollection","models/writeOffProduct"],function(e){var t=e("collections/baseCollection"),n=e("models/writeOffProduct");return t.extend({model:n,initialize:function(e){this.writeOffId=e.writeOffId},url:function(){return baseApiUrl+"/writeoffs/"+this.writeOffId+"/products"}})}),define("blocks/writeOff/addProductForm",["require","kit/form/form","models/writeOffProduct"],function(e){var t=e("kit/form/form"),n=e("models/writeOffProduct");return t.extend({writeOffId:null,initialize:function(){t.prototype.initialize.apply(this,arguments);var e=this;e.autocompleteToInput(e.$el.find("[lh_product_autocomplete='name']")),e.autocompleteToInput(e.$el.find("[lh_product_autocomplete='sku']")),e.autocompleteToInput(e.$el.find("[lh_product_autocomplete='barcode']"))},submit:function(){var e=this,t=$.Deferred(),r=Backbone.Syphon.serialize(e),i=new n({writeOff:{id:e.writeOffId}});return i.save(r,{error:function(e,n){t.reject(JSON.parse(n.responseText))},success:function(e){t.resolve(e)}}),t.promise()},showErrors:function(e){var t=this;t.removeErrors(),_.each(e.children,function(e,n){var r;if(e.errors){r=e.errors.join(", ");if(n=="product"){var i;t.$el.find("[lh_product_autocomplete='barcode']").val()?i="barcode":t.$el.find("[lh_product_autocomplete='sku']").val()?i="sku":i="name",t.$el.find("[lh_product_autocomplete='"+i+"']").closest(".form__field").attr("lh_field_error",r)}else t.$el.find("[name='"+n+"']").closest(".form__field").attr("lh_field_error",r)}})},autocompleteToInput:function(e){var t=e.attr("lh_product_autocomplete");e.autocomplete({source:function(e,n){$.ajax({url:baseApiUrl+"/products/"+t+"/search.json",dataType:"json",data:{query:e.term},success:function(e){n($.map(e,function(e){return{label:e[t],product:e}}))}})},minLength:3,select:function(e,t){$(this).parents("form").find("[lh_product_autocomplete='name']").val(t.item.product.name),$(this).parents("form").find("[lh_product_autocomplete='sku']").val(t.item.product.sku),$(this).parents("form").find("[lh_product_autocomplete='barcode']").val(t.item.product.barcode),$(this).parents("form").find("[name='product']").val(t.item.product.id),$(this).parents("form").find("[name='price']").val(t.item.product.retailPrice||t.item.product.purchasePrice),$(this).parents("form").find("[name='quantity']").focus()}}),e.keyup(function(e){var n=$.ui.keyCode;switch(e.keyCode){case n.PAGE_UP:case n.PAGE_DOWN:case n.UP:case n.DOWN:case n.ENTER:case n.NUMPAD_ENTER:case n.TAB:case n.LEFT:case n.RIGHT:case n.ESCAPE:return;default:var r=$(this).autocomplete("getTerm");if(r!=$(this).val()){var i=["name","sku","barcode","price"];for(var s in i)i[s]!=t&&$(this).parents("form").find("[lh_product_autocomplete='"+i[s]+"']").val("").trigger("input");$(this).parents("form").find("[name='product']").val("")}}})}})}),define("tpl!blocks/writeOff/templates/writeOff.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="page__controls">    <a class="page__controlsLink writeOff__editLink">Редактировать</a>    <a class="page__controlsLink writeOff__stopEditLink">Завершить редактирование</a></div><div class="writeOff__content">    <div class="writeOff__head">    </div>    <table class="writeOff__table table">    </table>    <div class="writeOff__footer">    </div></div><div class="page__clear"></div><form class="form writeOff__addProductForm">    <h3>Добавить товар в списание</h3>    <input type="hidden" name="product">    <div class="form__field form__field_inline">        <label class="form__label">Наименование</label>        <input class="inputText" type="text" lh_product_autocomplete="name"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Артикул</label>        <input class="inputText" type="text" lh_product_autocomplete="sku"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Штрихкод</label>        <input class="inputText" type="text" lh_product_autocomplete="barcode"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Количество</label>        <input class="inputText" type="text" name="quantity"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Цена</label>        <input lh_product_autocomplete="price" class="inputText" type="text" name="price"/>    </div>    <div class="form__field form__field_inline">        <label class="form__label">Причина</label>        <textarea class="inputText" name="cause"></textarea>    </div>    <div class="form__controls">        <span class="button button_color_blue writeOff__addMoreProduct">            Добавить товар            <input type="submit"/>        </span>        <a class="button writeOff__stopEditButton">            Завершить редактирование        </a>    </div></form>');return __p.join("")}}),define("tpl!blocks/writeOff/templates/dataInput.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<form class="writeOff__dataInput">    <input class="inputText"           type="text"           name="',$dataElement.attr("model-attr"),'"           value="',_.escape($.trim($dataElement.html())),'"/>    <input type="submit" /></form>');return __p.join("")}}),define("tpl!blocks/writeOff/templates/dataInputAutocomplete.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<form class="writeOff__dataInput">    <input class="inputText"           type="text"           lh_product_autocomplete="',$dataElement.attr("autocomplete-name"),'"           value="',_.escape($.trim($dataElement.html())),'"/>    <input type="submit" />    <input type="hidden"           name="',$dataElement.attr("model-attr"),'"           value="',$dataElement.attr("product-id"),'" /></form>');return __p.join("")}}),define("tpl!blocks/writeOff/templates/dataInputControls.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="writeOff__dataInputControls">    <a class="button writeOff__dataInputSave">        Сохранить    </a>    <span style="vertical-align: middle">    или    <a class="writeOff__dataInputCancel">отменить изменения</a>    </span></div>');return __p.join("")}}),define("tpl!blocks/writeOff/templates/footer.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('Итого<span name="totalProducts" class="writeOff__totalProducts">',block.writeOffModel.get("itemsCount")||0,'</span>позиций на сумму<span name="totalSum" class="writeOff__totalSum">',LH.helpers.formatPrice(block.writeOffModel.get("sumTotal")),"</span>рублей");return __p.join("")}}),define("tpl!blocks/writeOff/templates/head.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="writeOff__title writeOff__dataRow">    Списание    <span class="writeOff__editable">        №        <span name="number" model-attr="number">            ',_.escape(block.writeOffModel.get("number")),'        </span>    </span>    от    <span name="date" class="writeOff__editable" model-attr="date">        ',moment(block.writeOffModel.get("date")).format("DD.MM.YYYY"),"    </span></div>");return __p.join("")}}),define("tpl!blocks/writeOff/templates/removeConfirm.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<tr class="writeOff__removeConfirmRow" writeOff-product-id="',writeOffProductId,'">    <td colspan="6">        <a class="button writeOff__removeConfirmButton">Подтвердить</a>        <a class="writeOff__removeCancel">отменить удаление</a>    </td></tr>');return __p.join("")}}),define("tpl!blocks/writeOff/templates/row.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<tr writeOff-product-id="',writeOffProduct.id,'" name="writeOffProduct" class="writeOff__dataRow" product-sku="',writeOffProduct.product.sku,'">    <td>        <span name="productName"              class="writeOff__editable"              autocomplete-name="name"              model-attr="product"              product-id="',writeOffProduct.product.id,'">',writeOffProduct.product.name,'</span>        <br />        <span name="productSku"              class="writeOff__editable"              autocomplete-name="sku"              model-attr="product"              product-id="',writeOffProduct.product.id,'">',writeOffProduct.product.sku,'</span>    </td>    <td>        <span name="productBarcode"              class="writeOff__editable ',writeOffProduct.product.barcode?"":"writeOff__hiddenData",'"              autocomplete-name="barcode"              model-attr="product"              product-id="',writeOffProduct.product.id,'">            ',writeOffProduct.product.barcode?writeOffProduct.product.barcode:"Ввести штрихкод",'        </span>    </td>    <td>        <span class="writeOff__editable">            <span name="productAmount" model-attr="quantity">                ',writeOffProduct.quantity,'            </span>            <span name="productUnits">                ',LH.helpers.units(writeOffProduct.product.units,"smallShort"),'            </span>        </span>    </td>    <td>        <span class="writeOff__editable">            <span>                по            </span>            <span name="productPrice" model-attr="price">                ',LH.helpers.formatPrice(writeOffProduct.price),'            </span>            <span>                р.            </span>        </span>    </td>    <td>        <span class="writeOff__editable" name="productCause" model-attr="cause">            ',writeOffProduct.cause,'        </span>    </td>    <td style="width: 1px;">        <span class="writeOff__removeLink">удалить</span>    </td></tr>');return __p.join("")}}),define("tpl!blocks/writeOff/templates/table.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push("<tbody>    "),_.each(block.writeOffProductCollection.toJSON(),function(e){__p.push("        ",block.templates.row({writeOffProduct:e,block:block}),"    ")}),__p.push("</tbody>");return __p.join("")}}),define("blocks/writeOff/writeOff",["require","kit/block","kit/inputDate/inputDate","models/writeOff","collections/writeOffProducts","helpers/helpers","blocks/writeOff/addProductForm","tpl!./templates/writeOff.html","tpl!./templates/dataInput.html","tpl!./templates/dataInputAutocomplete.html","tpl!./templates/dataInputControls.html","tpl!./templates/footer.html","tpl!./templates/head.html","tpl!./templates/removeConfirm.html","tpl!./templates/row.html","tpl!./templates/table.html"],function(e){var t=e("kit/block"),n=e("kit/inputDate/inputDate"),r=e("models/writeOff"),i=e("collections/writeOffProducts"),s=e("helpers/helpers"),o=e("blocks/writeOff/addProductForm");return t.extend({editMode:!1,dataEditing:!1,className:"writeOff",blockName:"writeOff",templates:{index:e("tpl!./templates/writeOff.html"),dataInput:e("tpl!./templates/dataInput.html"),dataInputAutocomplete:e("tpl!./templates/dataInputAutocomplete.html"),dataInputControls:e("tpl!./templates/dataInputControls.html"),footer:e("tpl!./templates/footer.html"),head:e("tpl!./templates/head.html"),removeConfirm:e("tpl!./templates/removeConfirm.html"),row:e("tpl!./templates/row.html"),table:e("tpl!./templates/table.html")},initialize:function(){var e=this;e.writeOffProductCollection=new i({writeOffId:e.writeOffId}),e.writeOffModel=new r({id:e.writeOffId}),e.writeOffModel.fetch(),e.writeOffProductCollection.fetch(),e.render(),e.set("editMode",e.editMode),e.addForm=new o({writeOffId:e.writeOffId,el:e.el.getElementsByClassName("writeOff__addProductForm")}),e.listenTo(e.addForm,{successSubmit:function(t){e.writeOffProductCollection.push(t),e.addForm.clear()}}),e.listenTo(e.writeOffModel,"sync change",function(){e.$head.html(e.templates.head({block:e})),e.$footer.html(e.templates.footer({block:e}))}),e.listenTo(e.writeOffProductCollection,{sync:function(){e.renderTable()},add:function(t){e.renderTable(),e.writeOffModel.set(t.toJSON().writeOff)},change:function(t){e.writeOffModel.set(t.toJSON().writeOff)},destroy:function(){e.renderTable(),e.writeOffModel.fetch()}})},events:{"click .writeOff__removeLink":function(e){e.preventDefault();var t=this,n=$(e.target).closest(".writeOff__dataRow").attr("writeOff-product-id");t.showRemoveConfirm(n)},"click .writeOff__removeCancel":function(e){e.preventDefault();var t=this,n=$(e.target).closest(".writeOff__removeConfirmRow").attr("writeOff-product-id");t.hideRemoveConfirm(n)},"click .writeOff__removeConfirmButton":function(e){e.preventDefault();var t=this,n=$(e.target).closest(".writeOff__removeConfirmRow").attr("writeOff-product-id");t.removeWriteOffProduct(n),t.set("dataEditing",!1)},"click .writeOff__editLink":function(e){e.preventDefault();var t=this;t.set("editMode",!0)},"click .writeOff__stopEditLink, .writeOff__stopEditButton":function(e){e.preventDefault();var t=this,n=!1;t.addForm.$el.find(".inputText").each(function(){$(this).val()&&(n=!0)}),n||t.dataEditing?alert("У вас есть несохранённые данные"):t.set("editMode",!1)},"click .writeOff__editable":function(e){e.preventDefault(),e.stopPropagation();var t=this;t.editMode&&!t.dataEditing&&t.showDataInput($(e.currentTarget))},"submit .writeOff__table .writeOff__dataInput":function(e){e.preventDefault();var t=this,n=Backbone.Syphon.serialize(e.target),r=$(e.target).closest("[writeOff-product-id]").attr("writeOff-product-id"),i=t.writeOffProductCollection.get(r),s=$(e.target).find('[type="submit"]').closest(".button");t.removeInlineErrors(),s.addClass("preloader"),i.save(n,{success:function(){t.set("dataEditing",!1),s.removeClass("preloader")},error:function(e,n){t.showInlineErrors(JSON.parse(n.responseText)),s.removeClass("preloader")}})},"submit .writeOff__head .writeOff__dataInput":function(e){e.preventDefault();var t=this,n=Backbone.Syphon.serialize(e.target),r=$(e.target).find('[type="submit"]').closest(".button");t.removeInlineErrors(),r.addClass("preloader"),t.writeOffModel.save(n,{success:function(){t.set("dataEditing",!1),r.removeClass("preloader")},error:function(e,n){t.showInlineErrors(JSON.parse(n.responseText)),r.removeClass("preloader")},wait:!0})},"click .writeOff__dataInputSave":function(e){e.preventDefault();var t=this,n=t.$el.find(".writeOff__dataInput");n.submit()},"click .writeOff__dataInputCancel":function(e){var t=this;e.preventDefault(),t.removeDataInput()}},"set:editMode":function(e){var t=this;e?t.$el.addClass("writeOff_editMode"):t.$el.removeClass("writeOff_editMode")},"set:dataEditing":function(e){var t=this;t.addForm.disable(e),e?t.$el.addClass("writeOff_dataEditing"):t.$el.removeClass("writeOff_dataEditing")},showRemoveConfirm:function(e){var t=this,n=t.$table.find('.writeOff__dataRow[writeOff-product-id="'+e+'"]');t.hideRemoveConfirms(),t.set("dataEditing",!0),n.after(t.templates.removeConfirm({writeOffProductId:e})).hide()},hideRemoveConfirm:function(e){var t=this,n=t.$table.find('.writeOff__dataRow[writeOff-product-id="'+e+'"]'),r=t.$table.find('.writeOff__removeConfirmRow[writeOff-product-id="'+e+'"]');r.remove(),n.show(),t.set("dataEditing",!1)},hideRemoveConfirms:function(){var e=this,t=e.$table.find(".writeOff__dataRow:hidden"),n=e.$table.find(".writeOff__removeConfirmRow");t.show(),n.remove()},removeWriteOffProduct:function(e){var t=this,n=t.writeOffProductCollection.get(e);n.destroy({wait:!0})},renderTable:function(){var e=this;e.$table.html(e.templates.table({block:e}))},showInlineErrors:function(e){var t=this,n=t.$el.find(".writeOff__dataInput .inputText"),r=t.$el.find(".writeOff__dataInputControls");n.addClass("inputText_error"),_.each(e.children,function(e){var t;e.errors&&(t=e.errors.join(", "),r.attr("lh_field_error",t))})},removeInlineErrors:function(){var e=this,t=e.$el.find(".writeOff__dataInput .inputText"),n=e.$el.find(".writeOff__dataInputControls");t.removeClass(".inputText_error"),n.removeAttr("lh_field_error")},showDataInput:function(e){var t=this,r=e,i=e.closest(".writeOff__dataRow"),s=t.templates.dataInputControls();t.set("dataEditing",!0),r.attr("model-attr")||(r=e.find("[model-attr]")),i.prop("tagName")==="TR"&&(s='<tr class="writeOff__dataInputControlsTr"><td class="writeOff__dataInputControlsTd" colspan="'+i.find("td").length+'">'+s+"</td></tr>");switch(r.attr("model-attr")){case"product":r.append(t.templates.dataInputAutocomplete({$dataElement:r})),t.autocompleteToInput(r.find("[lh_product_autocomplete]"));break;case"date":r.append(t.templates.dataInput({$dataElement:r})),new n({el:r.find(".inputText")[0],noTime:!0});break;default:r.append(t.templates.dataInput({$dataElement:r}))}i.after(s),r.find(".inputText").css({width:r.width(),font:r.css("font")}).focus()},removeDataInput:function(){var e=this;e.$el.find(".writeOff__dataInput").remove(),e.$el.find(".writeOff__dataInputControls").remove(),e.$el.find(".writeOff__dataInputControlsTr").remove(),e.set("dataEditing",!1)},autocompleteToInput:function(e){var t=e.attr("lh_product_autocomplete");e.autocomplete({source:function(e,n){$.ajax({url:baseApiUrl+"/products/"+t+"/search.json",dataType:"json",data:{query:e.term},success:function(e){n($.map(e,function(e){return{label:e[t],product:e}}))}})},minLength:3,select:function(e,t){$(this).parents("form").find("[lh_product_autocomplete='name']").val(t.item.product.name),$(this).parents("form").find("[lh_product_autocomplete='sku']").val(t.item.product.sku),$(this).parents("form").find("[lh_product_autocomplete='barcode']").val(t.item.product.barcode),$(this).parents("form").find("[name='product']").val(t.item.product.id),$(this).parents("form").find("[name='price']").val(t.item.product.purchasePrice||t.item.product.retailPrice),$(this).parents("form").find("[name='quantity']").focus()}}),e.keyup(function(e){var n=$.ui.keyCode;switch(e.keyCode){case n.PAGE_UP:case n.PAGE_DOWN:case n.UP:case n.DOWN:case n.ENTER:case n.NUMPAD_ENTER:case n.TAB:case n.LEFT:case n.RIGHT:case n.ESCAPE:return;default:var r=$(this).autocomplete("getTerm");if(r!=$(this).val()){var i=["name","sku","barcode"];for(var s in i)i[s]!=t&&$(this).parents("form").find("[lh_product_autocomplete='"+i[s]+"']").val("").trigger("input");$(this).parents("form").find("[name='product']").val("")}}})}})}),define("tpl!blocks/writeOffForm/templates/writeOffForm.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="form__field form__field_inline">    <span style="vertical-align: middle; margin-right: 5px;">Списание №</span>    <input class="inputText"           type="text"           name="number"/>    <span style="vertical-align: middle; margin: 0 5px 0 10px;">от</span>    <input style="width: 200px;"           class="inputText"           value="',moment().format("DD.MM.YYYY"),'"           type="text"           name="date"           require="/kit/inputDate/inputDate_noTime.js"/></div><div class="form__controls">    <span class="button button_color_blue">        ',"Сохранить и перейти к добавлению товаров",'        <input type="submit"/>    </span></div>');return __p.join("")}}),define("blocks/writeOffForm/writeOffForm",["require","kit/form/form","models/writeOff","helpers/helpers","moment","routers/mainRouter","tpl!./templates/writeOffForm.html"],function(e){var t=e("kit/form/form"),n=e("models/writeOff"),r=e("helpers/helpers"),i=e("moment"),s=e("routers/mainRouter");return t.extend({writeOffFormId:null,writeOffModel:new n,className:"writeOffForm",templates:{index:e("tpl!./templates/writeOffForm.html")},submit:function(){var e=this,t=$.Deferred(),n=Backbone.Syphon.serialize(e);return e.writeOffModel.save(n,{success:function(e){s.navigate("/writeOff/"+e.id+"?editMode=true",{trigger:!0})},error:function(e,n){t.reject(JSON.parse(n.responseText))}}),t.promise()}})}),define("collections/writeOff",["require","collections/baseCollection","models/writeOff"],function(e){var t=e("collections/baseCollection"),n=e("models/writeOff");return t.extend({model:n,url:baseApiUrl+"/writeoffs"})}),define("tpl!blocks/writeOffList/templates/writeOffList.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<table class="table writeOffList__table">    ',block.templates.table({block:block}),"</table>");return __p.join("")}}),define("tpl!blocks/writeOffList/templates/table.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push("<thead><tr>    <th>Дата</th>    <th>Номер</th>    <th>Сумма</th></tr></thead><tbody>"),_.each(block.writeOffCollection.toJSON(),function(e){__p.push("    ",block.templates.row({block:block,writeOff:e}),"")}),__p.push("</tbody>");return __p.join("")}}),define("tpl!blocks/writeOffList/templates/row.html",function(){return function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<tr name="writeOff" href="/writeOff/',writeOff.id,'">    <td>        <span name="date">',moment(writeOff.date).format("DD.MM.YYYY"),'</span>    </td>    <td>        <span name="number">',writeOff.number,'</span>    </td>    <td>        <span name="sumTotal">',LH.helpers.formatPrice(writeOff.sumTotal),"</span>        <span>р.</span>    </td></tr>");return __p.join("")}}),define("blocks/writeOffList/writeOffList",["require","kit/block","collections/writeOff","moment","tpl!./templates/writeOffList.html","tpl!./templates/table.html","tpl!./templates/row.html"],function(e){var t=e("kit/block"),n=e("collections/writeOff"),r=e("moment");return t.extend({writeOffCollection:new n,className:"writeOffList",templates:{index:e("tpl!./templates/writeOffList.html"),table:e("tpl!./templates/table.html"),row:e("tpl!./templates/row.html")},initialize:function(){var e=this;e.render(),e.listenTo(e.writeOffCollection,{reset:function(){e.renderTable()},request:function(){e.$table.find("thead").addClass("preloader_rows")}}),e.writeOffCollection.fetch()},renderTable:function(){var e=this;e.$table.html(e.templates.table({block:e})).find("thead").removeClass("preloader_rows")}})}),require({baseUrl:"/",paths:{tpl:"libs/require/tpl"},packages:[{name:"moment",location:"libs/moment",main:"moment.min"}]},["helpers/helpers","routers/mainRouter"],function(e,t){window.LH={helpers:e},$(function(){Backbone.history.start({pushState:!0}),$("body").on("click","[href]",function(e){e.preventDefault(),t.navigate($(this).attr("href"),{trigger:!0})})})}),define("main",function(){});